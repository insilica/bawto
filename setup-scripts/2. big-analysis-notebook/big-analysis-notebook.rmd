---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

# Data loading

```{r}
library(patchwork)
library(dplyr)
library(googlesheets4)
library(survival)
library(survminer)
library(reshape2)
library(scales)
library(ggkm)
library(ggparty)
library(plotly)
library(ggplot2)
library(data.table)
library(metafor)

# Date used for the BAWTO cutoff

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
googlesheets4::gs4_get("1W976quowC86nAblSN3Nr6pAr4e-jdhEjrmrvs_48B_4") # use this to login to google quickly
# rm(list=ls())

glDF   <- RSysrev::sysrev.getGroupLabelAnswers(81395)

HRD.baseDF <- RSysrev::sysrev.getLabelAnswers(81395) %>% filter(reviewer.name=="tom") %>% select(Article.ID=article.id,lbl.name,answer) %>% 
  group_by(Article.ID,lbl.name) %>% summarize(answer=paste(answer,collapse=";")) %>% 
  reshape2::dcast(Article.ID~lbl.name,value.var = "answer") %>% rename(trial=`NCT Trial ID`) 

ctDF <- {
    con <- dbConnect(dbDriver('PostgreSQL'), dbname="aact",
                     host="aact-db.ctti-clinicaltrials.org", port=5432,
                     user="tomlue", password="s2bfr7acdjHJYh3")
    trials <- sprintf("('%s')",paste(HRD.baseDF$trial,collapse="','"))
    df2 <- dbGetQuery(con,sprintf("SELECT nct_id,start_date,primary_completion_date,completion_date,phase,brief_title
                                 FROM studies where nct_id in %s",trials))
    dbDisconnect(con)
    df2 %>% rename(trial=nct_id) %>% inner_join(HRD.baseDF)
}
 

# SAAD and profound trials use same HRD definition
# 18 genes

triton2_2_DRD <- c("BRCA1","BRCA2")
galahad_DRD   <- c('BRCA1','BRCA2','ATM','FANCA','PALB2','CHEK2','BRIP1','HDAC2')
talapro1_DRD  <- c('ATM','ATR','BRCA1','BRCA2','CHEK2','FANCA','MLH1','MRE11A','NBN','PALB2','RAD51C')
triton_DRD    <- c('BRCA2','ATM','FANCA','CHEK2','BRCA1','PALB2','HDAC2','RAD51','MLH3','ERCC3','MRE11','NBN')
chinnHRD      <- c('BRCA1','BRCA2','ATM','FANCA','PALB2','RAD51B','RAD51C')
saadHRD       <- c('ATM','BARD1','BRCA1','BRCA2','BRIP1','CDK12','CHEK1','CHEK2','FANCL','PALB2','PPP2R2A','RAD51B','RAD51C','RAD51D','RAD54L')
profHRD       <- c('BRIP1','BARD1','CDK12','CHEK1','CHEK2','FANCL','PALB2','PPP2R2A','RAD51B','RAD51C','RAD51D','RAD54L','BRCA2','BRCA1','ATM')
triton2_1     <- c('-BRCA1','-BRCA2','ATM','BARD1','BRIP1','CDK12','CHEK2','FANCA','NBN','PALB2','RAD51','RAD51B','RAD51C','RAD51D','RAD54L')
moranDRD      <- c('BRCA2','ATM','FANCA','CHEK2','BRCA1','PALB2','HDAC2','RAD51','MLH3','ERCC3','MRE11','NBN','BARD1','BRIP1','CDK12','RAD51B','RAD51C','RAD51D','RAD54L')


DRD <- c(triton2_2_DRD,galahad_DRD,talapro1_DRD,triton_DRD,chinnHRD,saadHRD,profHRD,triton2_1,moranDRD) %>% unique()

relDF  <- glDF$`relative outcomes` %>% filter(User.ID==139) %>% 
  inner_join(HRD.baseDF %>% select(Article.ID,trial,short_name,has_patient_level_data),by="Article.ID") %>% 
  mutate(int_num_patients  = as.numeric(int_num_patients)) %>%  
  mutate(comp_num_patients = as.numeric(comp_num_patients)) %>%  
  select(trial,short_name,Article.ID,Arm,`prior-treatment`,has_patient_level_data,
         int_treatment,int_biomarker,int_biomarker_modifier,int_biomarker_positive,int_num_patients,
         comp_treatment,comp_biomarker,comp_biomarker_modifier,comp_biomarker_positive,comp_num_patients,
         outcome_type,outcome_value,confidence_interval,CI_percent,
         median_duration_months,model_type,figure_table_section) %>% 
  rowwise() %>% 
  do(data.frame(.,hash=digest::digest(.),stringsAsFactors = F)) %>% 
  ungroup() %>% 
  mutate(int_treatment_class = case_when(
    int_treatment %in% c("AAP or Enz", "AAP", "AAP + placebo") ~ "ARD",
    int_treatment %in% c("olaparib","AAP + veliparib","AAP + olaparib") ~ "PARPi",
    T ~ "other"
  ))

spop_ratio <- glDF$`Single Outcomes Ratio` %>% 
  mutate_at(vars(num_patients,num_response,duration_months),as.numeric) %>% 
  mutate(rate = num_response / num_patients) %>% 
  filter(num_patients > 5) %>% 
  rowwise() %>% mutate(conf.min = prop.test(num_response,num_patients)$conf.int[1], conf.max = prop.test(num_response,num_patients)$conf.int[2]) %>% ungroup() %>% 
  inner_join(HRD.baseDF) %>% 
  select(-arm)

spop_outcome <- glDF$single_population_outcomes %>% inner_join(HRD.baseDF,by="Article.ID") %>% 
  mutate(outcome_value = as.numeric(outcome_value)) 
  # mutate_at(vars(num_patients,num_response,duration_months),as.numeric) %>% 
  # mutate(rate = num_response / num_patients) %>% 
  # filter(num_patients > 5) %>% 
  # rowwise() %>% mutate(conf.min = prop.test(num_response,num_patients)$conf.int[1], conf.max = prop.test(num_response,num_patients)$conf.int[2]) %>% ungroup() %>% 
  # inner_join(HRD.baseDF) %>% 
  # select(-arm)

biomarker.elig <- glDF$bio %>% inner_join(HRD.baseDF,by="Article.ID") %>% filter(User.ID==139) %>% 
  select(Article.ID,short_name,biomarker.name,DRD,eligibility)
```

# Utility functions

```{r}
# gives hazard ratios for a model built w/ coxph(Surv(PFS,death) ~ treatment,df)
getHazardRatio <- function(x,digitsval=5){
  x <- summary(x)
  HR <-signif(x$coef[2], digits=digitsval);#exp(beta)
  HR.confint.lower <- signif(x$conf.int[,"lower .95"],digitsval)
  HR.confint.upper <- signif(x$conf.int[,"upper .95"],digitsval)
  HR <- gsub("0\\.",".",paste0(HR, " ", HR.confint.lower, "-", HR.confint.upper, ""))
  return(HR)
}

getHazardRatioNum <- function(x){
  x <- summary(x)
  HR <-signif(x$coef[1,2], digits=5);#exp(beta)
  lower <- signif(x$conf.int[1,"lower .95"],5)
  upper <- signif(x$conf.int[1,"upper .95"],5)
  logUB <- log(upper)
  logLB <- log(lower)
  SE = (logUB-logLB)/(2*1.96)
  return(list(HR=HR,logHR = log(HR), lower=lower,upper=upper,se=SE))
}

hazardRatioFromDF <- function(df,treatment,treatment.value,filter.variable,filter.variable.value,time,event,nofilter=F){
  if(nofilter){
    tmp <- df %>% mutate(treatment = treatment == treatment.value)
    formula = as.formula(sprintf("Surv(%s,%s) ~ %s",time,event,treatment))
    tryCatch(
      expr    = {coxph(formula,tmp) %>% getHazardRatio()},
      warning = {function(cond){NA}},
      error   = {function(cond){NA}})
  }else{
    tmp <- df %>% filter_at(.vars = c(filter.variable),all_vars(. == filter.variable.value)) %>% mutate(treatment = treatment == treatment.value)
    formula = as.formula(sprintf("Surv(%s,%s) ~ %s",time,event,treatment))
    tryCatch(
      expr    = {coxph(formula,tmp) %>% getHazardRatio()},
      warning = {function(cond){NA}},
      error   = {function(cond){NA}})
  }
}

```


# Manual extractions
Which papers have patient level data?

```{r}
HRD.baseDF %>% filter(has_patient_level_data == "true") %>% select(Article.ID,short_name) %>% distinct()
# manually extracted data is on google drive at 1W976quowC86nAblSN3Nr6pAr4e-jdhEjrmrvs_48B_4
extractions_sheet <- googlesheets4::gs4_get("1W976quowC86nAblSN3Nr6pAr4e-jdhEjrmrvs_48B_4")
sheets <- data.frame(name=extractions_sheet$sheets$name,id=extractions_sheet$sheets$id) %>% 
  rowwise() %>%  
  mutate(url = sprintf("https://docs.google.com/spreadsheets/d/1W976quowC86nAblSN3Nr6pAr4e-jdhEjrmrvs_48B_4/edit#gid=%s",id)) %>% 
  ungroup()


# article.id, treatment, comparator, biomarker, hr, conf.interval
treatment_HRdfs <- list()
clinDF <- list() # patient_id,pfs_months,censored
biomDF <- list() # patient_id,variable,value
```

## 11781739 - TRITON2-2
No enrichment or treatment comparison hazard ratios

```{r}
# no enrichment HRS (only has BRCA1 and BRCA2, no negatives)
# no treatment HRS (only treatment is rucaparib)
# TODO psa change is available
# TODO this has the annoyance of not having real patient_ids so these two tibbles cannot be joined or binded
sheets %>% filter(grepl("11781739",name))
tritonDF22_psa <- range_read(extractions_sheet,sheet = "11781739-done-figure-1B") %>% select(patient_id,psa_updown,psa_response,BRCA1,BRCA2)

tritonDF22_PFS <- range_read(extractions_sheet,sheet = "11781739-done-figure-S3") %>%
  select(patient_id,pfs_weeks,censored,BRCA1,BRCA2) %>% 
  mutate(pfs_months = pfs_weeks * 7 / 30,censored,BRCA1,BRCA2) %>% 
  mutate(patient_id = patient_id + length(unique(tritonDF22_psa$patient_id))) %>% 
  mutate(patient_id = sprintf("%s-%s","11781739",patient_id)) %>% 
  mutate(BRCA1 = ifelse(BRCA1=="y","germline_altered",ifelse(BRCA1=="g","somatic_altered","normal"))) %>% # n = none, y = germline, g = somatic
  mutate(BRCA2 = ifelse(BRCA2=="y","germline_altered",ifelse(BRCA2=="g","somatic_altered","normal"))) 

cdf1 <- tritonDF22_PFS %>% select(patient_id,pfs_months,censored) 

bdf1 <- tritonDF22_PFS %>% select(patient_id,BRCA1,BRCA2) %>% reshape2::melt(id.vars="patient_id")

clinDF[['triton2-2']] <- cdf1 %>% mutate(treatment="rucaparib")
biomDF[['triton2-2']] <- bdf1
# TODO get those PSA numbers!

```

## 11781743 - TRITON2-1
```{r}
# no enrichment HRS (all patients have an HRD mutation)
# no treatment HRS (only treatment is rucaparib)
# TODO has PFS_months
# TODO has psa_response and radiographic_response

sheets %>% filter(grepl("11781743",name))
# TODO several other extractions here.
# patient_gene_alterations <- range_read(extractions_sheet,sheet = "11781743-done-fig-s2") %>% select(patient_id,gene) %>% reshape2::dcast(patient_id ~ gene)
triton21DF <- range_read(extractions_sheet,sheet = "11781743-done-PFS-Figures") %>% 
  mutate(patient = sprintf("%s-%s","11781743",patient)) %>% 
  mutate_at(vars(-patient,-figure,-pfs_months,-censored),.funs= ~ ifelse(is.na(.),"normal",.)) %>% 
  reshape2::melt(id.vars=c("patient","figure","pfs_months","censored")) %>% 
  mutate(value = case_when(
    value == "Bg" ~ "biallelic_somatic_altered",
    value == "Ug" ~ "somatic_altered",
    value == "Mg" ~ "monoallelic_somatic_altered",
    value == "Uy" ~ "germline_altered",
    value == "Un" ~ "altered",
    value == "Mn" ~ "monoallelic",
    value == "My" ~ "monoallelic_germline",
    value == "normal" ~ "normal",
    value == "Bn" ~ "biallelic_altered",
    value == "By" ~ "biallelic_germline_altered"
  )) 

clinDF[["triton2-1"]] <- triton21DF %>% select(patient_id=patient,pfs_months,censored) %>% 
  mutate(treatment="rucaparib") %>% 
  group_by(patient_id) %>% mutate(pfs_months = mean(pfs_months)) %>% ungroup() %>% distinct()

assertthat::assert_that(max((clinDF$`triton2-1` %>% group_by(patient_id) %>% count())$n) == 1)

biomDF[["triton2-1"]] <- triton21DF %>% select(patient_id=patient,variable,value) %>% distinct()

assertthat::assert_that(max((biomDF$`triton2-1` %>% group_by(patient_id,variable) %>% count())$n)==1)
```

## 11781742 - Chinnaiyan Extraction figure 2
Chinnaiyan compares AAP to AAP+veliparib with a biomarker stratification on ETS fusion

```{r cache=T,cache.path="./cache"}
# enrichment HRDFs
# treatment HRDFs
sheets %>% filter(grepl("11781742",name))  # only using one sheet, the other sheet has patients from a different study and unlinked to clinical variables
sheet <- range_read(extractions_sheet,sheet = "11781742-done-figure-2A",col_types = "c") 

# want patient_id, therapy, outcomes, model_features
chinnDF <- sheet %>% mutate_all(as.character) %>% 
  rename(PFS=`PFS Months`,DRD=`DRD Status`,censored=Censored) %>% 
  mutate(PFS = as.numeric(PFS)) %>% 
  mutate(treatment = ifelse(is.na(VEL),"AAP","AAP + veliparib")) %>% 
  mutate(censored = !is.na(censored)) %>% # T = death, F = alive and censored is NA for patients who are dead
  mutate(progressed = !censored) %>% 
  mutate_at(vars(ETS_Fusions,BRCA2,ATM,BRCA1,RAD51B,RAD51C,PALB2,FANCA,AR,TP53,PTEN,FOXA1,ZBTB16,
                 NCOR1,NCOR2,PIK3CA,PIK3CB,PIK3RI,AKT1,APC,CTNNB1,RNF43,
                 RSPO2,RB1,CHD1,SPOP,ZFHX3),.funs= ~ ifelse(is.na(.),FALSE,TRUE)) %>% 
  rowwise() %>% mutate(HRDc = max(ATM,BRCA1,BRCA2,PALB2,RAD51B,RAD51C,FANCA) == 1) %>% ungroup() %>% 
  rowwise() %>% mutate(PIK3 = max(PIK3CA,PIK3CB,PIK3RI) == 1) %>% ungroup() %>%
  rowwise() %>% mutate(any  = max(ETS_Fusions,BRCA2,ATM,BRCA1,RAD51B,RAD51C,PALB2,FANCA,AR,TP53,PTEN,FOXA1,ZBTB16,
                 NCOR1,NCOR2,PIK3CA,PIK3CB,PIK3RI,AKT1,APC,CTNNB1,RNF43,
                 RSPO2,RB1,CHD1,SPOP,ZFHX3)) %>% ungroup() %>%
  mutate(DRD_del = DRD=="biallelic")

(function(){
  # activity of PTEN is controlled by the PI3K pathway. 
  # coxph(Surv(PFS,progressed) ~ treatment,data=chinnDF %>% filter(PIK3)) %>% getHazardRatio()
  # ggsurvplot(survfit(Surv(PFS,censored)~PTEN + DRD_del,data=chinnDF),data=chinnDF,risk.table = T,break.time.by=3) 
  
  # Replicating Figure 2C in paper
  # coxph(Surv(PFS,progressed) ~ DRD_del,data=chinnDF %>% filter(treatment == "AAP")) %>% getHazardRatio()
  # ggsurvplot(survfit(Surv(PFS,progressed)~DRD_del,data=chinnDF),data=chinnDF,risk.table = T,break.time.by=3)
  
  # Replicating Figure 3
  # g1 <- ggsurvplot(survfit(Surv(PFS,progressed)~DRD_del,data=chinnDF %>% filter(treatment=="AAP")),data=chinnDF,risk.table = T,break.time.by=3) 
  # g2 <- ggsurvplot(survfit(Surv(PFS,progressed)~DRD_del,data=chinnDF %>% filter(treatment=="AAP + veliparib")),data=chinnDF,risk.table = T,break.time.by=3)
  # arrange_ggsurvplots(list(g1,g2))
}) # replicating figures

build_rel_row <- function(variable){hazardRatioFromDF(chinnDF,"treatment","AAP + veliparib",variable,T,"PFS","progressed")}
build_rel_not_row <- function(variable){hazardRatioFromDF(chinnDF,"treatment","AAP + veliparib",variable,F,"PFS","progressed")}
n.patients <- function(df,patient_id,filter.variables,filter.value){
  df %>% filter_at(filter.variables,all_vars(.==filter.value)) %>% select_at(patient_id) %>% distinct() %>% nrow()
}

chinn.biomarkers <- c('ETS_Fusions','BRCA2','ATM','BRCA1','RAD51B','RAD51C','PALB2','FANCA','AR','TP53','PTEN','FOXA1','ZBTB16','NCOR1','NCOR2','PIK3CA','PIK3CB','PIK3RI','AKT1','APC','CTNNB1','RNF43','RSPO2','RB1','CHD1','SPOP','ZFHX3','DRD_del',"HRDc")

chinn.biomarkers.hrd <- c("HRDc","DRD_del","BRCA2","BRCA1","ATM","PALB2","RAD51B","RAD51C")

df <- data.frame(variable = chinn.biomarkers,stringsAsFactors = F) %>% 
  rowwise() %>% mutate(AAP_vs_Veli_HR = build_rel_row(variable)) %>% ungroup() %>% 
  rowwise() %>% mutate(AAP_vs_Veli_HR_not = build_rel_not_row(variable)) %>% ungroup() 


chinnHR <- df %>% 
  filter(!is.na(AAP_vs_Veli_HR),!is.na(AAP_vs_Veli_HR_not),!grepl("NA",AAP_vs_Veli_HR),!grepl("NA",AAP_vs_Veli_HR_not)) %>% 
  rename(biomarker=variable) %>% 
  reshape2::melt(id.vars="biomarker") %>% 
  mutate(biomarker.positive = ifelse(variable=="AAP_vs_Veli_HR","positive","negative")) %>% 
  mutate(Article.ID=11781742,treatment="AAP + veliparib",comparator="AAP") %>% 
  rowwise() %>% mutate(HR = as.numeric(strsplit(value," ")[[1]][1]),conf.interval=strsplit(value," ")[[1]][2]) %>% ungroup() %>% 
  rowwise() %>% mutate(conf.min = as.numeric(strsplit(conf.interval,"-")[[1]][1]),conf.max=as.numeric(strsplit(conf.interval,"-")[[1]][2])) %>% ungroup() %>% 
  rowwise() %>% mutate(int.patients  = chinnDF %>% filter(treatment=="AAP") %>% filter_at(vars(biomarker),all_vars(.==T)) %>% nrow(),
                       comp.patients = chinnDF %>% filter(treatment=="AAP + veliparib") %>% filter_at(vars(biomarker),all_vars(.==T)) %>% nrow()) %>% 
  ungroup() %>% 
  mutate(outcome_type="PFS",biomarker.type="altered",short_name="Chinnaiyan 2019",trial="NCT01576172",prior.treatment="prior-adt") %>% 
  select(Article.ID,trial,short_name,intervention=treatment,comparator,biomarker,biomarker.type,biomarker.positive,
         int.patients,comp.patients,HR,conf.interval,conf.min,conf.max,outcome_type,
         prior.treatment) %>% filter(!is.na(HR))


# Article.Id, intervention, comparator, biomarker, int.patients, comp.patients, HR, conf.interval, conf.min, conf.max, outcome_type
treatment_HRdfs[["chinnaiyan"]] = chinnHR 
clinDF[["chinnaiyan"]] <- chinnDF %>% 
  mutate(patient_id = sprintf("%s-%s","11781742",patient_id)) %>% 
  mutate(censored = ifelse(censored,"censored","progressed")) %>% 
  select(patient_id,pfs_months=PFS,censored=censored,treatment)
  
biomDF[["chinnaiyan"]] <- chinnDF %>% 
  mutate(patient_id = sprintf("%s-%s","11781742",patient_id)) %>% 
  select(-psa_updown,-psa_response,-treatment,-censored,-progressed,-PFS,-ABI,-VEL) %>% 
  reshape2::melt(id.vars=c("patient_id"))
```

### BRCA1/2 statement
```{r}
chinnBRCA <- chinnDF %>% 
  mutate_at(vars(BRCA1,BRCA2,ETS_Fusions,TP53),.funs = ~ ifelse(.,1,0)) %>% 
  rowwise() %>% mutate(anyBRCA = max(BRCA1,BRCA2)) %>% ungroup() %>% 
  mutate(progressed = ifelse(progressed,1,0)) %>% 
  mutate(DRD     = ifelse(DRD=="biallelic",1,0)) %>% 
  mutate(HRDc = ifelse(HRDc,1,0)) %>%
  select(patient_id,PFS,progressed,treatment,BRCA1,BRCA2,anyBRCA,DRD,HRDc,ETS_Fusions,TP53) 

coxph(Surv(PFS,progressed)~treatment,chinnDF %>% filter(ETS_Fusions)) %>% getHazardRatio()
coxph(Surv(PFS,progressed)~treatment,chinnDF %>% filter(ETS_Fusions)) %>% getHazardRatio()



ggplot(chinnBRCA,aes(time=PFS,status=progressed,color=treatment)) + geom_km() + facet_wrap(~ETS_Fusions + TP53)
ggplot(chinnBRCA,aes(time=PFS,status=progressed,color=treatment)) + geom_km() + facet_wrap(~DRD)

coxph(Surv(PFS,progressed)~DRD)
ggsurvplot(survfit(PFS,progressed)~DRD)
```


## 11781744 - Moran 2020

```{r}
# There just isn't much data here, only 3 patients with a response
# No enrichment HRS
# No treatment HRS?
(function(){
  sheets %>% filter(grepl("11781744",name)) %>% View()
  df <- range_read(extractions_sheet,sheet="11781744-done") %>% rename(psa_response=`psa response`)
})

```

## 11781747 - TOPARP-A
```{r}
# No enrichment HRs (no PFS or OS)
# No treatment HRs
# no PFS
# TODO need to add this to patient level data
sheets %>% filter(grepl("11781747",name)) 

# Lots of biomarkers but no survival times
toparpDF <- range_read(extractions_sheet,sheet="11781747-done-figure-1",col_types = "c")
# df2 <- range_read(extractions_sheet,sheet="11781747-done-table-2",col_types="c")  # only 16 rows, not much data

# clinDF[["toparp-A"]] = 
biomDF[["toparp-A"]] = toparpDF %>% mutate(patient_id=sprintf("11781747-%s",patient_id)) %>% 
  select(-weeks_on_treatment,-clinical_response,-biomarker_positive) %>%
  reshape2::melt(id.vars=c("patient_id"))

```

## 11781748 - KN_Chi 2018 - enzalutamide vs abiraterone
Has a comprehensive workbook.

```{r}
# Enrichment HRs
# Treatment HRs
sheets %>% filter(grepl("11781748",name)) 

treatment = range_read(extractions_sheet, sheet = "11781748-KNChi") %>% select(patient_id,treatment)

# mutations = range_read(extractions_sheet,sheet="11781748-table-S4") %>% 
#   filter(!grepl("WBC",patient_id)) %>%
#   select(patient_id,gene) %>% mutate(patient_id = as.numeric(patient_id)) %>% 
#   filter(!is.na(patient_id)) %>% distinct() %>% 
#   group_by(gene) %>% filter(n_distinct(patient_id) > 10) 

fig2Mutations <- range_read(extractions_sheet,sheet="11781748-Figure-2") %>% 
  mutate_at(vars(-patient_id),function(x){ifelse(x=="0 0 0","normal","altered")})

clinical <- range_read(extractions_sheet,sheet="11781748-table-S1",col_types = "c") %>% 
  select(patient_id,age,OS=days_to_death_or_last_followup,survival_censorship,PFS=days_to_progression_or_last_followup,progression_censorship,exome_sequenced,
         basic_panel=`72-gene panel sequenced`,AR_amplification,AR_rearrangement,AR_mutation) %>% 
  rowwise() %>% mutate(AR = paste(AR_amplification,AR_rearrangement,AR_mutation,collapse=",")) %>% ungroup() %>% select(-AR_amplification,-AR_rearrangement,-AR_mutation) %>% 
  mutate_at(vars(-progression_censorship,-survival_censorship,-exome_sequenced,-basic_panel,-AR),as.numeric) %>% 
  mutate(died = survival_censorship == "No") %>% 
  mutate(progressed = progression_censorship == "No") %>% 
  mutate(AR = ifelse(AR == "NA NA NA","normal","altered")) %>% 
  select(patient_id,OS,died,PFS,progressed,AR)

chiDF <- clinical %>% inner_join(treatment,by="patient_id") %>% inner_join(fig2Mutations,by="patient_id") %>% 
  mutate(`cell_cycle` = ifelse(TP53=="altered" | RB1=="altered" | MDM2=="altered" | CDKN2A=="altered" | MYC=="altered" | CCND1=="altered","altered","normal")) %>% 
  mutate(`PI3K_pathway` = ifelse(PTEN=="altered" | PIK3R1=="altered" | PIK3CA=="altered" | PIK3CB=="altered" | AKT1=="altered","altered","normal")) %>% 
  mutate(`WNT_pathway` = ifelse(APC=="altered" | CTNNB1=="altered" | RNF43=="altered","altered","normal")) %>% 
  mutate(`DNA_repair` = ifelse(BRCA2=="altered" | BRCA1=="altered" | ATM=="altered" | CDK12=="altered" | MSH2=="altered" | 
                                 MSH6=="altered" | MLH1 == "altered" | FANCA == "altered","altered","normal")) %>% 
  mutate(`AR_associated` = ifelse(FOXA1=="altered" | FOXP1=="altered" | ZBTB16=="altered" | AR == "altered","altered","normal")) %>% 
  mutate(`Chromatin_modifiers` = ifelse(KMT2C=="altered" | KMT2D=="altered" | CHD1=="altered" | KDM6A=="altered","altered","normal"))

aap_enz_OS_HR      <- function(variable){hazardRatioFromDF(chiDF,"treatment","abiraterone",variable,"altered","OS","died")}
aap_enz_OS_HR_not  <- function(variable){hazardRatioFromDF(chiDF,"treatment","abiraterone",variable,"normal","OS","died")}

app_enz_PFS_HR     <- function(variable){hazardRatioFromDF(chiDF,"treatment","abiraterone",variable,"altered","PFS","progressed")}
app_enz_PFS_HR_not <- function(variable){hazardRatioFromDF(chiDF,"treatment","abiraterone",variable,"normal","PFS","progressed")}

app_enz_OS_enrich_HR  <- function(variable){hazardRatioFromDF(chiDF,variable,"altered",NA,NA,"OS","died",nofilter = T)}
app_enz_PFS_enrich_HR <- function(variable){hazardRatioFromDF(chiDF,variable,"altered",NA,NA,"PFS","progressed",nofilter = T)}

n.patients    <- function(treatment_val,variable,value){chiDF %>% filter(treatment==treatment_val) %>% filter_at(vars(variable),any_vars(. == value)) %>% nrow()}
variables     <- setdiff(colnames(chiDF),c("patient_id","age","OS","died","PFS","progressed","treatment"))

hazardRatioFromDF(chiDF,"treatment","abiraterone","cell_cycle","altered","OS","died")

chi_OS_HR <- data.frame(variable = variables,stringsAsFactors = F) %>% 
  rowwise() %>% mutate(aap_enz_OS_HR = aap_enz_OS_HR(variable)) %>% ungroup() %>% 
  rename(biomarker=variable) %>% 
  reshape2::melt(id.vars="biomarker") %>% 
  filter(variable=="aap_enz_OS_HR",!is.na(value)) %>% 
  mutate(Article.ID=11781748,intervention="abiraterone",comparator="enzalutamide") %>% 
  rowwise() %>% mutate(HR = strsplit(value," ")[[1]][1],conf.interval=strsplit(value," ")[[1]][2]) %>% ungroup() %>% 
  rowwise() %>% mutate(conf.min = strsplit(conf.interval,"-")[[1]][1],conf.max=strsplit(conf.interval,"-")[[1]][2]) %>% ungroup() %>% 
  rowwise() %>% mutate(int.patients  = n.patients("abiraterone",biomarker,"altered"),comp.patients = n.patients("enzalutamide",biomarker,"altered")) %>% ungroup() %>% 
  select(Article.ID,intervention,comparator,biomarker,int.patients,comp.patients,HR,conf.interval,conf.min,conf.max) %>% mutate(outcome_type="OS",biomarker.positive="positive")

chi_OS_HR_n <- data.frame(variable = variables,stringsAsFactors = F) %>% 
  rowwise() %>% mutate(aap_enz_OS_HR = aap_enz_OS_HR_not(variable)) %>% ungroup() %>% 
  rename(biomarker=variable) %>% 
  reshape2::melt(id.vars="biomarker") %>% 
  filter(variable=="aap_enz_OS_HR",!is.na(value)) %>% 
  mutate(Article.ID=11781748,intervention="abiraterone",comparator="enzalutamide") %>% 
  rowwise() %>% mutate(HR = strsplit(value," ")[[1]][1],conf.interval=strsplit(value," ")[[1]][2]) %>% ungroup() %>% 
  rowwise() %>% mutate(conf.min = strsplit(conf.interval,"-")[[1]][1],conf.max=strsplit(conf.interval,"-")[[1]][2]) %>% ungroup() %>% 
  rowwise() %>% mutate(int.patients  = n.patients("abiraterone",biomarker,"normal"),comp.patients = n.patients("enzalutamide",biomarker,"normal")) %>% ungroup() %>% 
  select(Article.ID,intervention,comparator,biomarker,int.patients,comp.patients,HR,conf.interval,conf.min,conf.max) %>% mutate(outcome_type="OS",biomarker.positive="negative")

chi_PFS_HR <- data.frame(variable = variables,stringsAsFactors = F) %>% 
  rowwise() %>% mutate(app_enz_PFS_HR = app_enz_PFS_HR(variable)) %>% ungroup() %>% 
  rename(biomarker=variable) %>% 
  reshape2::melt(id.vars="biomarker") %>% 
  filter(variable=="app_enz_PFS_HR",!is.na(value)) %>% 
  mutate(Article.ID=11781748,intervention="abiraterone",comparator="enzalutamide") %>% 
  rowwise() %>% mutate(HR = strsplit(value," ")[[1]][1],conf.interval=strsplit(value," ")[[1]][2]) %>% ungroup() %>% 
  rowwise() %>% mutate(conf.min = strsplit(conf.interval,"-")[[1]][1],conf.max=strsplit(conf.interval,"-")[[1]][2]) %>% ungroup() %>% 
  rowwise() %>% mutate(int.patients  = n.patients("abiraterone",biomarker,"altered"),comp.patients = n.patients("enzalutamide",biomarker,"altered")) %>% ungroup() %>% 
  select(Article.ID,intervention,comparator,biomarker,int.patients,comp.patients,HR,conf.interval,conf.min,conf.max) %>% mutate(outcome_type="PFS",biomarker.positive="positive")

chi_PFS_HR_n <- data.frame(variable = variables,stringsAsFactors = F) %>% 
  rowwise() %>% mutate(app_enz_PFS_HR = app_enz_PFS_HR_not(variable)) %>% ungroup() %>% 
  rename(biomarker=variable) %>% 
  reshape2::melt(id.vars="biomarker") %>% 
  filter(variable=="app_enz_PFS_HR",!is.na(value)) %>% 
  mutate(Article.ID=11781748,intervention="abiraterone",comparator="enzalutamide") %>% 
  rowwise() %>% mutate(HR = strsplit(value," ")[[1]][1],conf.interval=strsplit(value," ")[[1]][2]) %>% ungroup() %>% 
  rowwise() %>% mutate(conf.min = strsplit(conf.interval,"-")[[1]][1],conf.max=strsplit(conf.interval,"-")[[1]][2]) %>% ungroup() %>% 
  rowwise() %>% mutate(int.patients  = n.patients("abiraterone",biomarker,"normal"),comp.patients = n.patients("enzalutamide",biomarker,"normal")) %>% ungroup() %>% 
  select(Article.ID,intervention,comparator,biomarker,int.patients,comp.patients,HR,conf.interval,conf.min,conf.max) %>% mutate(outcome_type="PFS",biomarker.positive="negative")

chi.HR.all.cox = coxph(Surv(OS,progressed)~treatment,chiDF) %>% getHazardRatioNum()

chi.HR.all = data.frame(Article.ID=11781748,intervention="abiraterone",comparator="enzalutamide",biomarker="Full Cohort") %>% 
  mutate(int.patients = nrow(chiDF %>% filter(treatment=="abiraterone")),comp.patients=nrow(chiDF %>% filter(treatment == "enzalutamide"))) %>% 
  mutate(HR = chi.HR.all.cox$HR, conf.interval=NA, conf.min=chi.HR.all.cox$lower, conf.max=chi.HR.all.cox$upper,outcome_type="OS",biomarker.positive=NA,biomarker.type=NA)

chiHR = chi_OS_HR %>% rbind(chi_PFS_HR) %>% rbind(chi_PFS_HR_n) %>% rbind(chi_OS_HR_n) %>% 
  mutate_at(vars(HR,conf.min,conf.max),as.numeric) %>% mutate(biomarker.type="altered") %>% 
  dplyr::bind_rows(chi.HR.all) %>% 
  mutate(short_name="Kim N. Chi 2018",trial="NCT02125357", prior.treatment="no-prior-taxane;no-prior-AR-directed")


# TODO report the response rates for CHI
chiRR = chiDF %>% group_by(treatment,progressed,DNA_repair) %>% count() %>% ungroup() %>% 
  reshape2::dcast(treatment + DNA_repair ~ progressed, value.var="n") %>% 
  mutate(rate = `TRUE` / (`TRUE` + `FALSE`))

treatment_HRdfs[['11781748']] = chiHR 

# clinDF = patient_id,treatment,pfs_months,censored,OS,died
clinDF[["chi"]] = chiDF %>% 
  mutate(censored = ifelse(progressed,"progressed","censored")) %>% 
  mutate(pfs_months = PFS / 30.437) %>% 
  select(patient_id,treatment,pfs_months,censored,OS,died) %>% 
  mutate(patient_id = sprintf("11781748-%s",patient_id))

# biomDF = 
biomDF[["chi"]] = chiDF %>% select(-treatment,-PFS,-progressed,-OS,-died) %>% mutate(patient_id = sprintf("11781748-%s",patient_id)) %>% 
  reshape2::melt(id.vars=c("patient_id"))
```

## Combined PFS
```{r}
c1 <- chinnDF %>% 
  mutate(treatment = ifelse(grepl("veliparib",treatment),"PARPi","ARD")) %>% 
  mutate(patient_id=sprintf("chinnaiyan_%s",patient_id)) %>% 
  select(patient_id,treatment,PFS,progressed,BRCA1,BRCA2,ATM,PALB2,FANCA,RAD51C,RAD51B) %>% 
  melt(id.vars=c("patient_id","treatment","PFS","progressed")) %>% 
  mutate(value = ifelse(value,"altered","normal")) %>% 
  mutate(trial = "chinnaiyan")

c2 <- chiDF %>% 
  mutate(treatment = "ARD", PFS = PFS / 30) %>% 
  mutate(patient_id=sprintf("chi_%s",patient_id)) %>% 
  select(patient_id,treatment,PFS,progressed,BRCA1,BRCA2,ATM,FANCA,CDK12,MLH1,MSH2,MSH6) %>% 
  melt(id.vars=c("patient_id","treatment","PFS","progressed")) %>% 
  mutate(trial = "chi")

c3 <- tritonDF22_PFS %>% 
  mutate(treatment = "PARPi") %>% 
  mutate(progressed = censored=="progressed") %>% 
  select(patient_id,treatment,PFS=pfs_months,progressed,BRCA1,BRCA2) %>%
  melt(id.vars=c("patient_id","treatment","PFS","progressed")) %>% mutate(value=ifelse(value=="normal","normal","altered")) %>% 
  mutate(trial = "triton2-2")

c4 <- triton21DF %>% 
  mutate(treatment = "PARPi") %>% 
  mutate(progressed = censored=="progressed") %>% 
  select(patient_id=patient,treatment,PFS=pfs_months,progressed,variable,value) %>% 
  mutate(value=ifelse(value=="normal","normal","altered")) %>% 
  mutate(trial= "triton2-1")


# return(list(HR=HR,logHR = log(HR), lower=lower,upper=upper,se=SE))
HRme      <- function(df){
  tryCatch(expr={
    coxph(Surv(PFS,progressed)~treatment_num,data = df) %>% getHazardRatioNum() %>% as.data.frame()
    },warning = {function(cond){data.frame()}},error   = {function(cond){data.frame()}})
}

comb <- rbind(c1 %>% filter(treatment=="PARPi"),c2,c3,c4) %>%
  mutate(value=as.factor(value)) %>% 
  mutate(progressed = ifelse(progressed,1,0)) %>% 
  group_by(variable,value) %>% mutate(parp_patients=sum(treatment=="PARPi"),ard_patients=sum(treatment=="ARD")) %>% 
  ungroup() %>% 
  mutate(treatment_num = ifelse(treatment=="PARPi",1,0)) 

d.comb <- comb %>% 
  dcast(patient_id + PFS + progressed + treatment_num ~ variable) %>% 
  mutate_at(vars(-patient_id,-PFS,-progressed,-treatment_num),.funs = ~ ifelse(.=="normal",0,1)) %>% 
  rowwise() %>% 
  mutate(any_alter = max(BRCA1,BRCA2,ATM,PALB2,FANCA,RAD51C,RAD51B,CDK12,MLH1,MSH2,MSH6,BRIP1,CHEK2,NBN,RAD51,RAD54L,
                         na.rm = T)) %>%
  ungroup()

allHR = coxph(Surv(PFS,progressed)~treatment_num,d.comb) %>% getHazardRatioNum()
anyHR = coxph(Surv(PFS,progressed)~treatment_num,d.comb %>% filter(any_alter==1)) %>% getHazardRatioNum()
nonHR = coxph(Surv(PFS,progressed)~treatment_num,d.comb %>% filter(any_alter==0)) %>% getHazardRatioNum()

comb.HR.all <- data.frame(
  biomarker=c("all","any_alter","no_alter"),
  HR    = c(allHR$HR,   anyHR$HR,   nonHR$HR), 
  lower = c(allHR$lower,anyHR$lower,nonHR$lower), 
  upper = c(allHR$upper,anyHR$upper,nonHR$upper), 
  se    = c(allHR$se,anyHR$se,nonHR$se),
  parp_patients = c(
    d.comb %>% filter(treatment_num==1) %>% nrow(),
    d.comb %>% filter(treatment_num==1,any_alter==1) %>% nrow(),
    d.comb %>% filter(treatment_num==1,any_alter==0) %>% nrow()
  ),
  ard_patients  = c(
    d.comb %>% filter(treatment_num==0) %>% nrow(),
    d.comb %>% filter(treatment_num==0,any_alter==1) %>% nrow(),
    d.comb %>% filter(treatment_num==0,any_alter==0) %>% nrow()
  )) %>% 
  mutate(biomarker.positive = NA) %>% 
  select(biomarker,biomarker.positive,parp_patients,ard_patients,HR,lower,upper,se)

comb.HR <- comb %>% 
  group_by(variable,value,parp_patients,ard_patients) %>% do(HRme(.)) %>% ungroup() %>% 
  mutate(biomarker = variable, biomarker.positive = value) %>% 
  select(biomarker,biomarker.positive,parp_patients,ard_patients,HR,lower,upper,se) %>% 
  rbind(comb.HR.all)



ggplot(comb, aes(time = PFS, status = progressed,col=trial)) + geom_km()  + facet_grid(~treatment) + 
  theme(text=element_text(size=21))
```

# Figures

```{r}
biomarker.names = googlesheets4::range_read("1-8IdZiim0Oe7F2ExQe9XpNxruyWH2YHxyeBI0q_3Hfs","biomarker.names")
biomarker.name.map <- function(name){ if(name %in% biomarker.names$biomarker){biomarker.names[which(biomarker.names$biomarker == name),]$name[1]}else{warning(sprintf("%s illegal name",name))} }
biomarker.type.map <- function(name){ biomarker.names[which(biomarker.names$biomarker == name),]$type[1] }
biomarker.isdrd    <- function(name){ biomarker.names[which(biomarker.names$biomarker == name),]$DRD[1] }
```

## Fig x - prisma
```{r cache=T,cache.path="./cache"}
library(rsvg)
mawtoLabels <- RSysrev::sysrev.getGroupLabelAnswers(70431)

studies  <- mawtoLabels$Populations %>% 
  mutate(Pop_Value = trimws(Pop_Value)) %>% 
  # filter(Pop_Value %in% gs$human_gene_symbol) %>% 
  filter(Pop_Value %in% c(DRD,"DRD", "HRD", "HRR","HHR", "DNA repair", "repair", "homologous")) %>%
  select(Article.ID) %>% 
  distinct()

source("../scripts/DataNormalization.R")
source("../scripts/ConcordantScreeningData.R")
screen    <- getConcordantScreeningData()
screen$synthesis2  = screen$synthesis + 5
Figure1   <- (function(){
  
  g <- DiagrammeR::grViz(sprintf('digraph prisma {
      newrank=true;
    	node [shape="box", fontsize = 12, width=2];
    	graph [compound=true,splines=ortho, nodesep=0.25, rankdir=TB];

      subgraph cluster_0 {
        label="A. ClinicalTrials.gov BAWTO Screen"
        style=filled;
        fillcolor=lightgrey;
        margin=8
        c_id    [label="Records found   \non clinicaltrials.gov\n(n=%d)"];
        c_scr   [label="Records screened\n(n=%d)"];
        c_excl  [label="Records excluded\n(n=%d)"];
        c_incl  [label="Records included\n(n=%d)"]
        c_doc   [label="Related Records \nidentified\n(n=%d)", fillcolor=darkslategray1, style=filled];

        c_id -> c_scr;
        c_scr -> c_excl;
        c_scr -> c_incl;
        c_incl  -> c_doc;
      }

      subgraph cluster_1 {
        label="B. PubMed BAWTO Screen"
        style=filled;
        fillcolor=lightgrey;
        margin=8
        p_id    [label="Records identified\non pubmed.gov\n(n=%d)"];
        c2_id    [label="Records identified\nfrom clinicaltrials.gov*\n(n=%d)", fillcolor=darkslategray1, style=filled];

        dedup     [label="Records after\nduplicates removed\n(n=%d)",width=3]
        screening [label="Records screened\n(n=%d)",width=2]
        excluded  [label="Records excluded\n(n=%d)",width=2]  

        c2_id -> dedup;
        p_id  -> dedup;
        dedup -> screening;
        screening -> excluded;

        fulltext_scr  [label="full-text articles assessed\n for eligibility\n(n=%d)"];
        fulltext_excl [label="Full-text articles excluded\n (n=%d)\n\nno data for prostate cancer patients (n=%d)\nno mutation data (n = %d)\nno outcome data (n=%d)"];
        screening -> fulltext_scr;
        fulltext_scr -> fulltext_excl;

        fulltext_incl [label="studies included in\nquantitative synthesis\n(n=%d)", fillcolor=lightpink,style=filled];
        fulltext_scr -> fulltext_incl;
      }

      subgraph cluster_2 {
        label="C. HRD and DRD in mCRPC"
        margin=8
        
        other_records [label="studies in conference abstracts\n and other reviews\n(n=5)"];        
        fulltext_incl2 [label="studies included in\nquantitative synthesis\n(n=%d)", fillcolor=lightpink,style=filled];
        
        dedup_2 [label = "Records after\nduplicates removed\n(n=52)",width=3]
        hrd_screen [label="Records Screened\n(n=%d)"];
        hrd_excl [label="Records Excluded\n(n=%d)\n\nNo HRD/DRD biomarkers\n(n=39)"];
        hrd_incl [label="studies included in\nquantitative synthesis\n(n=%d)", fillcolor=lightgoldenrodyellow,style=filled];
        
        fulltext_incl2 -> dedup_2; 
        other_records -> dedup_2;
        dedup_2 -> hrd_screen;
        hrd_screen -> hrd_excl;
        hrd_screen -> hrd_incl;

        { rank=same; hrd_screen; hrd_excl; }
      }

        { rank=same; c_scr; c_excl; }
        { rank=same; p_id; c2_id;}
        { rank=same; screening; excluded;}
        { rank=same; fulltext_scr; fulltext_excl; }
  
    }',
    screen$ctgov,screen$ctgov,screen$ctgov_excl,screen$ctgov_incl,screen$ctgov_ass,
    screen$pm,screen$ctgov_ass,screen$pm_screen,screen$pm_screen,screen$pm_excl,screen$fscreen,
    screen$fexcl,screen$no_data_for_prostate_cancer,screen$no_mutation_data,screen$no_outcome_data,
    screen$synthesis,
    screen$synthesis,
    screen$synthesis2, # records screened
    screen$synthesis-nrow(studies), # records excluded
    nrow(HRD.baseDF) # included studies
    ))
  g %>% export_svg() %>% charToRaw() %>% rsvg_svg("/home/thomas/tmp/graph.svg")
})
```

## Fig x - timeline

```{r cache=T,cache.path="./cache"}
drv <- dbDriver('PostgreSQL')
con <- dbConnect(drv, dbname="aact",
                 host="aact-db.ctti-clinicaltrials.org", port=5432,
                 user="tomlue", password="s2bfr7acdjHJYh3")

trials <- sprintf("('%s')",paste(HRD.baseDF$trial,collapse="','"))
ctgov.time <- dbGetQuery(con,sprintf("SELECT nct_id,start_date,primary_completion_date,completion_date FROM studies where nct_id in %s",trials))


dbDisconnect(con)

library(vistime)

trial_status_dates <- range_read(extractions_sheet,sheet = "trial-status-dates",col_types = "c") %>% 
  mutate(date = as.Date(date,format="%b %d %Y")) %>% 
  select(trial,event,date)

hrd_trials <- HRD.baseDF %>% 
  select(trial,short_name) %>%
  mutate(trial_short_name = case_when(
    grepl("TOPARP",short_name,ignore.case = T) ~ "TOPARP",
    grepl("TRITON",short_name,ignore.case = T) ~ "TRITON",
    grepl("PROfound",short_name,ignore.case = T) ~ "PROfound",
    T~short_name
    )) %>% select(trial,short_name=trial_short_name) %>% distinct() 

spectral = RColorBrewer::brewer.pal(6,"Spectral")

df2 <- ctgov.time %>% 
  reshape2::melt(id.vars="nct_id") %>% select(trial=nct_id,event=variable,date=value) %>% 
  rbind(trial_status_dates) %>% 
  filter(!(event %in% c("primary_completion_date","completed"))) %>% 
  group_by(trial) %>% arrange(date) %>% mutate(end = lead(date)) %>% ungroup() %>% 
  mutate(event=as.factor(event)) %>% 
  mutate(color = case_when(event=="start_date" ~ spectral[1],
                           event=="recruiting" ~ spectral[2],
                           event=="active_not_recruiting" ~ spectral[3],
                           event=="suspended"~ "red",
                           event=="primary_completion_date" ~ "green", 
                           event=="completion_date" ~ "black")) %>% 
  inner_join(hrd_trials,by="trial") %>% select(trial=short_name,event,start=date,end,color) %>% 
  filter(event != "completion_date")

test = df2 %>% mutate(x=1,y=1)
dummy <- ggplot(data=test, aes(x=x,y=y,fill=event)) + geom_bar(stat="identity") + scale_fill_manual(values=c(spectral[3],spectral[2],spectral[1],"red",spectral[3],"red","red"))
leg <- ggpubr::get_legend(dummy)

timeline = gg_vistime(df2,col.group="trial",col.event="event",show_labels = F,linewidth = 12) + 
  scale_x_datetime(breaks = breaks_width("6 months"), labels = date_format("%b-%Y")) + 
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45,hjust = 1,size=16)) + 
  theme(axis.text.y = element_text(size=18))


ggsave("../figures/timeline.legend.svg",plot=dummy)
ggsave(plot = timeline,filename = "../figures/timeline.svg",width=12,height=6,units = "in")
```

## Fig 0 - priors heatmap
```{r cache=T,cache.path="./cache"}
shortnames     = unique(HRD.baseDF$short_name)
drd_biomarkers = (biomarker.elig %>% filter(DRD == "true"))$biomarker.name %>% unique()
allnames = data.frame(
  short_name     = shortnames,
  biomarker.name = rep(drd_biomarkers,length(shortnames))
  ) %>% mutate(eligibility = "not_measured") 

plotDF <- allnames %>% 
  left_join(biomarker.elig %>% select(-Article.ID) %>% 
              group_by(biomarker.name) %>% 
              mutate(biomarker.trial.count = n_distinct(short_name)) %>% 
              ungroup()
            ,by=c("short_name","biomarker.name")) %>% 
  mutate(eligibility = ifelse(is.na(eligibility.y),eligibility.x,eligibility.y)) %>% 
  mutate(DRD = "true") %>%
  group_by(short_name) %>% mutate(biomarker.count = sum(eligibility != "not_measured")) %>% ungroup() %>% 
  group_by(biomarker.name) %>% mutate(biomarker.trial.count = max(biomarker.trial.count,na.rm = T)) %>% ungroup() %>% 
  select(-eligibility.x,-eligibility.y) %>% 
  mutate(eligibility = ifelse(eligibility=="sufficient","inclusion",ifelse(eligibility=="required_negative","exclusion",eligibility)))

ynames = c("Moran 2020","TOPARP-B","TRITON2-1","Saad 2018","PROfound-2","PROfound-1","TOPARP-A","TALAPRO-1","Kim N. Chi 2018",
           "GALAHAD","Chinnaiyan 2019","TRITON2-2","Friedlander 2015")
x.color = ifelse(ynames %in% c("TRITON2-1","TRITON2-2","Kim N. Chi 2018","Chinnaiyan 2019"),"red","black") %>% rev()
ggplot(plotDF,aes(reorder(biomarker.name,-biomarker.trial.count),reorder(short_name,biomarker.count),fill=eligibility)) + 
  geom_tile(col="black") + coord_equal() + 
  theme(legend.position = "bottom") + xlab("") + ylab("") + 
  theme(axis.text.x = element_text(hjust=1,angle=45),
        axis.text.y = element_text(color = x.color),
        legend.title = element_blank(),axis.text = element_text(size = 8))

ggsave("./figures/fig_biomarkers.svg",units="in",width = 7)
```

## Fig 1 - Two Arm OS HR
Overall Survival Hazard Ratios Profound and Chi are the only studies with this data.  

### A - tree map
```{r}
# TODO we need to correct this to do correct pooling
scale = c(RColorBrewer::brewer.pal(name = "Reds",n=9) %>% rev(),RColorBrewer::brewer.pal(name = "Greens",n=9)) %>% rev()
minoutcome = 0.2
maxoutcome = 2
tree <- range_read("https://docs.google.com/spreadsheets/d/1-8IdZiim0Oe7F2ExQe9XpNxruyWH2YHxyeBI0q_3Hfs/edit#gid=0", 
                   sheet = "Two Arm OS HR - A",col_types = "c") %>% 
  mutate(outcome= as.numeric(outcome)) %>% 
  mutate(colors = cut(outcome,breaks = seq(minoutcome,maxoutcome,0.1),ordered_result = T)) %>% 
  rowwise() %>% mutate(color = ifelse(outcome < minoutcome, scale[1], 
                                      ifelse(outcome > maxoutcome,tail(scale,n=1),scale[colors]))) %>% ungroup() %>%
  mutate(color=ifelse(is.na(outcome),"yellow",color)) %>% 
  mutate(patients = as.numeric(patients)) %>% 
  mutate(prevalence = round(100*patients / 387)) %>% 
  rowwise() %>% mutate(text = ifelse(leaf=="F",
                                     sprintf("%s %s<br>%s%%",gsub("0\\.",".",outcome),treemap_conf_text,prevalence),
                                     sprintf("%s<br>%s<br>%s%%",gsub("0\\.",".",outcome),treemap_conf_text,prevalence))) %>% ungroup()



fig <- plot_ly(tree,
               type     = "treemap",
               text     = ~text,
               labels   = ~biomarker,
               values   = ~patients,
               textinfo ="label+value+percent parent+percent root",
               texttemplate = "<b>%{label}</b><br>%{text}",
               parents  = ~parent,
               marker   = list(colors = ~color),
               branchvalues="total"
) #%>% layout(uniformtext=list(minsize=10, mode='show',maxsize=18))
fig
orca(fig, "treemap.svg",height = 800,width = 550,)
```

### B - Two arm HR
Create columns for OS, PFS and relative response
1. HR
2. Confidence Interval
3. Larger Font
4. 
```{r}
make.fig <- function(df,left.treatment,right.treatment){
  m.gen <- meta::metagen(TE          = logHR, 
                         seTE        = SE, 
                         studlab     = biomarker,
                         data        = df,
                         byvar = short_name,
                         title       = "overall survival")
  rows = df$rows
  colr = df$color
  meta::forest.meta(m.gen,
                    sortvar = rows,
                    col.study = colr,
                    col.square = colr,
                    col.square.lines = "black",
                    # studlab = T,
                    comb.fixed = F,
                    comb.random = F,
                    xlim = c(-2,2),
                    rightcols = c(),
                    just.addcols.left = "right", 
                    leftcols = c("biomarker","outcome.type"),
                    leftlabs = c("biomarker","outcome.type"),
                    smlab=sprintf("Log Hazard Ratio"))
}

# Prepare
forestDF <- relDF %>%
  rowwise() %>% mutate(biomarker = biomarker.name.map(int_biomarker)) %>% ungroup() %>% 
  filter(
    model_type=="uni-cox",
    int_biomarker == comp_biomarker,
    int_biomarker_modifier == comp_biomarker_modifier, 
    int_biomarker_positive == comp_biomarker_positive,
    int_biomarker_positive %in% c("NA","positive")
  ) %>%
  mutate(prior.treatment = case_when(
    prior.treatment == "prior-adt" ~ "ADT",
    prior.treatment == "prior-docetaxel" ~ "docetaxel",
    prior.treatment == "no-prior-taxane;no-prior-AR-directed" ~ "!taxane + !ARD",
    prior.treatment == "prior-AR-directed" ~ "ARD",
    prior.treatment == "prior-AR-directed;no-prior-taxane" ~ "ARD + !taxane",
    prior.treatment == "prior-AR-directed;prior-taxane" ~ "ARD + taxane",
    T ~ prior.treatment
  )) %>% 
  mutate(biomarker.positive = case_when(
    int_biomarker_modifier == "normal" ~ "negative",
    T ~ int_biomarker_positive
  )) %>% 
  mutate(outcome.type = case_when(
    outcome_type == "rPFS;RECIST1.1" ~ "rPFS",
    T ~ outcome_type
  )) %>% 
  rowwise() %>% 
  mutate(conf.interval = sprintf("%s (%s)",outcome_value,confidence_interval)) %>%
  mutate(HR            = as.numeric(outcome_value)) %>% 
  mutate(conf.min      = as.numeric(strsplit(confidence_interval,"-")[[1]][1])) %>% 
  mutate(conf.max      = as.numeric(strsplit(confidence_interval,"-")[[1]][2])) %>% 
  ungroup() %>% 
  rowwise() %>% mutate(biomarker = biomarker.name.map(int_biomarker)) %>% ungroup() %>% 
  mutate(logHR = log(HR), logLB = log(conf.min), logUB = log(conf.max)) %>% 
  mutate(SE = (logUB-logLB)/(2*1.96)) %>% 
  rename(int.treatment = int_treatment,comp.treatment = comp_treatment,int.patients=int_num_patients,comp.patients=comp_num_patients)

# SAAD
order <- c("Full Cohort","HRDp")
forest.saad <- forestDF %>% filter(trial=="NCT01972217") %>% 
  filter(outcome_type != "second rPFS", int_biomarker_modifier != "partially characterized") %>% 
  mutate(color = ifelse(biomarker.positive=="NA","gray",ifelse(biomarker.positive=="positive","chartreuse1","firebrick4"))) %>% 
  arrange(outcome.type,biomarker,biomarker.positive != "positive") %>% 
  mutate(rows=row_number()) %>% 
  select(short_name,prior.treatment,int.treatment,comp.treatment,biomarker,biomarker.positive,outcome.type,logHR,SE,rows,color,int.patients,comp.patients,HR,conf.interval)


# PROFOUND - gene, OS.HR, OS.
order = data.frame(biomarker = c("HRDp","HRDp - PPP2R2A","HRDp - BRCA1/2 - ATM","HRDp - BRCA1/2 - ATM - PPP2R2A","BRCA2,BRCA1,ATM","only BRCA1/2",
          "only BRCA2","only BRCA1","only ATM","only CDK12","only CHEK2","only PPP2R2A")) %>% mutate(biomarker.order = row_number())

forest.PROFound <- forestDF %>% filter(trial=="NCT02987543") %>% 
  mutate(color = "chartreuse1") %>% 
  left_join(order,by="biomarker") %>%
  filter(int_biomarker_modifier != "one qualifying or suspected deleterious alteration" ) %>% 
  mutate(rows=biomarker.order) %>% 
  select(short_name,prior.treatment,int.treatment,comp.treatment,biomarker,biomarker.positive,outcome.type,logHR,SE,rows,color,int.patients,comp.patients,
         HR,conf.interval)

# make.fig(forest.PROFound %>% filter(outcome.type=="OS"))
# make.fig(df %>% filter(outcome_type!="OS"),left.treatment="AAP + Veliparib", right.treatment = "AAP")

chinn.biomarker.order = data.frame(biomarker=c("Full Cohort","HRDc","DRD_del","BRCA2")) %>% mutate(rows=row_number())
forest.chinn <- forestDF %>% filter(trial=="NCT01576172") %>% 
  mutate(color="gray") %>% 
  mutate(outcome.type="cPFS") %>% 
  inner_join(chinn.biomarker.order) %>% 
  select(short_name,prior.treatment,int.treatment,comp.treatment,biomarker,biomarker.positive,outcome.type,logHR,SE,rows,color,int.patients,
         comp.patients)

forest.chinn.calculated <- chinnHR %>%
  mutate(logHR = log(HR), logLB = log(conf.min), logUB = log(conf.max)) %>%
  mutate(SE = (logUB-logLB)/(2*1.96)) %>%
  arrange(biomarker,biomarker.positive) %>%
  mutate(color = ifelse(biomarker.positive=="positive","chartreuse1","firebrick4")) %>%
  rename(int.treatment=intervention,comp.treatment=comparator,outcome.type=outcome_type) %>%
  filter(biomarker %in% chinn.biomarkers.hrd) %>%
  mutate(outcome.type="cPFS") %>%
  mutate(conf.interval = sprintf("%.2f-%.2f",conf.min,conf.max)) %>% 
  select(short_name,prior.treatment,int.treatment,comp.treatment,biomarker,biomarker.positive,outcome.type,logHR,SE,rows,color,int.patients,comp.patients,
         HR,conf.interval) %>%
  left_join(chinn.biomarker.order,by="biomarker") %>% 
  dplyr::bind_rows(forest.chinn) 
  

make.fig(forest.chinn.calculated,left.treatment="AAP + Veliparib", right.treatment = "AAP")

# CHI OS.HR
biomarker.order = data.frame(biomarker=c("Full Cohort","DNA_repair","BRCA2","BRCA1","ATM","CDK12","FANCA","MLH1")) %>% mutate(biomarker.order=row_number())

forest.chi.calculated <- chiHR %>%
  mutate(logHR = log(HR), logLB = log(conf.min), logUB = log(conf.max)) %>% 
  mutate(SE = (logUB-logLB)/(2*1.96)) %>% 
  arrange(biomarker,biomarker.positive) %>% 
  mutate(color = ifelse(is.na(biomarker.positive),"gray",ifelse(biomarker.positive=="positive","chartreuse1","firebrick4"))) %>% 
  filter(biomarker %in% c(DRD,"DNA_repair","Full Cohort")) %>% 
  mutate(prior.treatment = "!taxane + !ARD") %>% 
  rename(int.treatment=intervention,comp.treatment=comparator,outcome.type=outcome_type) %>% 
  left_join(biomarker.order,by="biomarker") %>% 
  arrange(biomarker.order,biomarker.positive=="negative") %>% mutate(rows=row_number()) %>% 
  mutate(biomarker = ifelse(biomarker=="DNA_repair","HRD_chi",biomarker)) %>% 
  mutate(conf.interval = sprintf("%.2f-%.2f",conf.min,conf.max)) %>% 
  select(short_name,prior.treatment,int.treatment,comp.treatment,biomarker,biomarker.positive,outcome.type,logHR,SE,rows,color,int.patients,comp.patients,HR,
         conf.interval)

make.fig(forest.chi.calculated %>% filter(outcome.type == "OS"),left.treatment="abiraterone", right.treatment = "enzalutamide")
make.fig(df %>% filter(outcome_type != "OS"),left.treatment="abiraterone", right.treatment = "enzalutamide")

# combined.HR
biomarker.order = data.frame(biomarker=c("Full Cohort","HRD_combined","BRCA2","BRCA1","ATM","CDK12","FANCA","MLH1")) %>% mutate(biomarker.order=row_number())
forest.combined <- comb.HR %>% 
  mutate(logHR = log(HR), logLB = log(lower), logUB = log(upper)) %>% 
  mutate(SE = (logUB-logLB)/(2*1.96)) %>% filter(!is.na(logHR)) %>% 
  mutate(int.patients=parp_patients,comp.patients=ard_patients) %>% 
  mutate(short_name = "combined") %>%
  mutate(biomarker.positive = as.character(biomarker.positive)) %>% 
  mutate(biomarker.positive = ifelse(biomarker=="any_alter","positive",ifelse(biomarker=="no_alter","negative",biomarker.positive))) %>% 
  mutate(color = ifelse(is.na(biomarker.positive),"gray",ifelse(biomarker.positive!="normal","chartreuse1","firebrick4"))) %>% 
  mutate(prior.treatment="mixed",outcome_type="aPFS") %>% 
  mutate(int.treatment = "PARPi",comp.treatment="ARD",outcome.type="aPFS") %>%
  mutate(biomarker = case_when(
    biomarker=="all" ~ "Full Cohort",
    biomarker=="any_alter" ~ "HRD_combined",
    biomarker=="no_alter" ~ "HRD_combined",
    T ~ as.character(biomarker))
    ) %>% 
  left_join(biomarker.order,by="biomarker") %>% mutate(rows=biomarker.order) %>%
  mutate(conf.interval = sprintf("%.2f-%.2f",lower,upper)) %>% 
  select(short_name,prior.treatment,int.treatment,comp.treatment,biomarker,biomarker.positive,outcome.type,logHR,SE,rows,color,int.patients,comp.patients,HR,conf.interval)

# Put them all together
forest.final <- dplyr::bind_rows(forest.saad,forest.PROFound,forest.chinn.calculated,forest.chi.calculated,forest.combined) %>% 
  mutate(prior.treatment = ifelse(prior.treatment == "prior-adt","ADT",prior.treatment)) %>% 
  filter(outcome.type != "second rPFS") %>% 
  filter(biomarker != "HRDp - BRCA1/2 - ATM - PPP2R2A") %>% 
  group_by(short_name,biomarker) %>% mutate(hasOS = sum(outcome.type=="OS") > 0) %>% ungroup() %>% 
  rowwise() %>% filter(!(hasOS & (outcome.type != "OS"))) %>% ungroup() %>% 
  mutate(biomarker = case_when(
    prior.treatment == "ARD + taxane" ~ sprintf("%s + taxane",biomarker),
    prior.treatment == "ARD + !taxane" ~ sprintf("%s - taxane",biomarker),
    T ~ biomarker
    ))

m.gen <- meta::metagen(TE          = logHR, 
                       seTE        = SE, 
                       studlab     = biomarker,
                       data        = forest.final,
                       byvar       = short_name,
                       title       = "overall survival")
rows = forest.final$rows
colr = forest.final$color

svg("./tmp/forest.HR.svg",width = 18, height=36,pointsize=12,onefile = T)

meta::forest.meta(m.gen,
                  sortvar = rows,
                  col.study = colr,
                  col.square = colr,
                  col.square.lines = "black",
                  # studlab = T,
                  comb.fixed = F,
                  comb.random = F,
                  xlim = c(-2,2),
                  rightcols = c(),
                  just.addcols.left = "right",
                  leftcols = c("biomarker","outcome.type"),
                  leftlabs = c("biomarker","oc"),
                  smlab=sprintf("Log Hazard Ratio"))
dev.off()
```

```{r}
# Article.ID,intervention,comparator,biomarker,biomarker.type,int.patients,comp.patients,HR,conf.interval,conf.min,conf.max,outcome_type,short_name,prior.treatment
manualExtracts <- do.call(rbind,treatment_HRdfs) %>% 
  select(Article.ID,trial,prior.treatment,short_name,prior.treatment,intervention,comparator,biomarker,biomarker.type,
         int.patients,comp.patients,HR,conf.interval,conf.min,conf.max,outcome_type) %>% mutate(biomarker.positive = T)

df <- relDF %>% 
  filter(
    model_type=="uni-cox",
    int_biomarker == comp_biomarker,
    int_biomarker_modifier == comp_biomarker_modifier, 
    int_biomarker_positive == comp_biomarker_positive,
    int_biomarker_positive %in% c("NA","positive")) %>%
  rowwise() %>% 
  mutate(conf.interval = sprintf("%s (%s)",outcome_value,confidence_interval)) %>%
  mutate(HR            = as.numeric(outcome_value)) %>% 
  mutate(conf.min      = as.numeric(strsplit(confidence_interval,"-")[[1]][1])) %>% 
  mutate(conf.max      = as.numeric(strsplit(confidence_interval,"-")[[1]][2])) %>% 
  ungroup() %>% 
  select(Article.ID,trial,short_name,prior.treatment,intervention=int_treatment,comparator=comp_treatment,
         biomarker          = int_biomarker,
         biomarker.type     = int_biomarker_modifier,
         biomarker.positive = int_biomarker_positive,
         int.patients=int_num_patients,comp.patients=comp_num_patients,
         HR,conf.interval,conf.min,conf.max,outcome_type)

# need to add chinnHR and chiHR
df2 <- df %>% #rbind(df,manualExtracts) %>% 
  filter(!is.na(HR),!is.na(biomarker)) %>% 
  group_by(short_name,biomarker,prior.treatment) %>% mutate(hasOS = "OS" %in% outcome_type) %>% ungroup() %>% 
  filter(!(hasOS & outcome_type != "OS")) %>% 
  mutate(biomarker.type = ifelse(biomarker.type=="qualifying or suspected deleterious alteration","altered",biomarker.type)) %>% 
  filter(biomarker.type %in% c("NA","altered")) %>% 
  rowwise() %>% mutate(biomarker.group = biomarker.type.map(biomarker)) %>% ungroup() %>% 
  rowwise() %>% mutate(biomarker       = biomarker.name.map(biomarker)) %>% ungroup() %>% 
  mutate(prior.treatment = case_when(
    prior.treatment == "prior-adt" ~ "ADT",
    prior.treatment == "prior-docetaxel" ~ "docetaxel",
    prior.treatment == "no-prior-taxane;no-prior-AR-directed" ~ "!taxane + !ARD",
    prior.treatment == "prior-AR-directed" ~ "ARD",
    prior.treatment == "prior-AR-directed;no-prior-taxane" ~ "ARD + !taxane",
    prior.treatment == "prior-AR-directed;prior-taxane" ~ "ARD + taxane",
    T ~ prior.treatment
  )) %>% 
  mutate(logHR = log(HR), logLB = log(conf.min), logUB = log(conf.max)) %>% 
  mutate(SE = (logUB-logLB)/(2*1.96), diff0 = ifelse(logHR < 0,pnorm(logHR / SE,0,SE,lower.tail = T),pnorm(logHR / SE,0,SE,lower.tail=F))) %>% 
  mutate(colour = ifelse(outcome_type=="OS","royalblue3","firebrick4")) %>% 
  group_by(short_name,biomarker) %>% mutate(minP = min(diff0),minHR=min(HR)) %>% ungroup() %>% 
  arrange(trial,biomarker.group!="background",biomarker.group!="group",biomarker.group!="complex",biomarker.group!="simple",minHR,HR) %>% mutate(row=row_number()) %>% 
  select(short_name,prior.treatment,intervention,comparator,biomarker,biomarker.type,biomarker.group,outcome_type,HR,logHR,conf.min,conf.max,
         diff0,SE,minP,logLB,logUB,
         colour,row,
         minHR,minP)
  

build_forest_plot <- function(df,name,left_labs=c("biomarker")){
  # biomarker, OS.HR, OS.SE, PFS.HR, PFS.SE, RR, RR.SE
  m.gen <- meta::metagen(TE          = logHR, 
                         seTE        = SE, 
                         studlab     = biomarker,
                         data        = df,
                         byvar = short_name,
                         title       = "overall survival")
  
  rows <- df$row
  colour <- df$colour
  leftlab <- df$intervention[1]
  rightlab <- df$comparator[1]
  
  makefig <- function(){
      meta::forest.meta(m.gen,
                    sortvar = rows,
                    col.study = colour,
                    # studlab = T,
                    comb.fixed = F,
                    comb.random = F,
                    xlim = c(-3,3),
                    rightcols = c(),
                    leftcols = left_labs,
                    leftlabs = left_labs,
                    smlab=sprintf("Log Hazard Ratio"),
                    label.left = leftlab,label.right = rightlab)
  }
  makefig()
  svg(sprintf("/home/thomas/tmp/%s",name),width = 18, height=24,pointsize=12)
  makefig()
  dev.off()
}
  
build_forest_plot(df2 %>% filter(outcome_type == "OS"),"test.svg",c("prior.treatment","biomarker"))
build_forest_plot(df2 %>% filter(outcome_type == "OS"),"test.svg",c("prior.treatment","biomarker"))
build_forest_plot(df2 %>% filter(short_name=="Chinnaiyan 2019"),"chinn.svg",c("prior.treatment","biomarker"))
build_forest_plot(df2 %>% filter(short_name=="Kim N. Chi 2018") %>% top_n(31,-minP),"chi.svg",c("prior.treatment","biomarker")) # 26 rows

build_forest_plot(df2 %>% filter(short_name %in% c("PROfound-2")),"PROfound.svg",c("prior.treatment","biomarker"))
build_forest_plot(df2 %>% filter(short_name=="Saad 2018"),"SAAD.svg",c("prior.treatment","biomarker"))
```

## Fig 2 - Enrichment
Try identifying all of the DRD mutations. Something like:

1. add background rates
2. radiographic progression
2. extract manually from patient level data from 6 above trials (step gives a lead in for patient level data analysis)???

```{r}
# you could pull more response rates from chinnHR if you wanted
# chinnDF %>% select(patient_id,psa_response,treatment,BRCA1,BRCA2,ATM,FANCA,PALB2,RAD51B,RAD51C,DRD_del) %>% melt(id.vars=c("patient_id","psa_response","treatment")) %>% 
#   group_by(variable,value,treatment) %>% summarize(responder = sum(psa_response=="TRUE",na.rm = T),no_response=sum(psa_response=="FALSE",na.rm = T)) %>% 
#   mutate(response_rate = responder / (responder + no_response)) %>% 
#   mutate(biomarker.positive = ifelse(value,"positive","negative")) %>% 
#   dcast(variable + biomarker.positive ~ treatment, value.var = "response_rate") %>% mutate(dif = `AAP` - `AAP + veliparib`) %>% arrange(dif)

HRD.baseDF[which(HRD.baseDF$short_name=="PROfound-1"),]

spop_ratio %>% inner_join(biomarker.names,by="biomarker") %>% filter(DRD=="DRD")

spop_plot_raw <- spop_ratio %>% inner_join(biomarker.names,by="biomarker") %>% 
  filter(DRD=="DRD") %>% filter(duration_months > 20) %>% 
  rowwise() %>% mutate(biomarker.group = biomarker.type.map(biomarker)) %>% ungroup() %>% 
  rowwise() %>% mutate(biomarker       = biomarker.name.map(biomarker)) %>% ungroup() %>% 
  mutate(biomarker_modifier = ifelse(biomarker_modifier %in% c("mutated","altered","qualifying or suspected deleterious alteration"),"", biomarker_modifier)) %>% 
  mutate(trial_treatment = sprintf("%s %s",short_name,treatment)) %>% 
  mutate(color = ifelse(biomarker_positive == "positive","chartreuse1","firebrick4"))

plotDF <- spop_plot_raw %>% 
  group_by(biomarker) %>% mutate(minrate = max(rate)) %>% ungroup() %>% 
  select(pop_modifier,trial,short_name,biomarker,biomarker_modifier,treatment,num_response,num_patients,biomarker_positive,
         color,minrate,rate,outcome_type) %>% distinct() %>% 
  arrange(trial,short_name,-minrate,treatment,biomarker_positive!="positive",-rate) %>% mutate(row = row_number()) %>% 
  filter(treatment != "AAP or AAP + veliparib") %>% 
  mutate(treatment = ifelse(treatment == "AAP or Enz;crossover to olaparib permitted","AAP or Enz",treatment)) %>% 
  mutate(treatment = ifelse(treatment == "enzalutamide + pembrolizumab","Enz + Pem",treatment))
  

psaDF <- plotDF %>% select(short_name,biomarker,biomarker_modifier,biomarker_positive,treatment,num_patients,num_response,outcome_type,row,color) %>% filter(outcome_type=="psa response")
radDF <- plotDF %>% select(short_name,biomarker,biomarker_modifier,biomarker_positive,treatment,num_patients,num_response,outcome_type,color,row) %>% 
  filter(outcome_type %in% c("radiographic response","RECIST/PCWG3 CR+PR", "RECIST_CR;RECIST_PR")) 

totDF <- psaDF %>% 
  full_join(radDF,by=c("short_name","biomarker","biomarker_modifier","biomarker_positive","treatment","color")) %>% 
  mutate_at(vars(num_response.y,num_response.x,num_patients.y,num_patients.x),  .funs= ~ ifelse(is.na(.),100,.)) %>% 
  mutate(lcolor = ifelse(num_response.x==100,"blue",color)) %>% 
  mutate(rcolor = ifelse(num_response.y==100,"blue",color)) %>% select(-color) %>% 
  mutate(row = ifelse(is.na(row.x),row.y,row.x))

makefig <- function(pdf,titleval,ratetitle,patienttitle){
  
  pdf$rate = pdf$num_response / pdf$num_patients
  
  m.gen <- meta::metaprop(
    event    = num_response,
    n        = num_patients,
    studlab  = biomarker,
    data     = pdf,
    title    = titleval)
    
    meta::forest(m.gen,
               sortvar = pdf$row,
               subgroup = T,
               print.subgroup.labels = T,
               xlim=c(0.0,1.0),
               col.study = pdf$color,
               col.square = pdf$color,
               col.square.lines = "black",
               col.label.left = "red",
               
               # studlab = T,
               comb.fixed = F,
               comb.random = F,
               leftlabs  = c("short_name","biomarker","biomarker_modifier","treatment"),
               leftcols  = c("short_name","biomarker","biomarker_modifier","treatment"),
               rightcols = c("rate","num_patients"),
               rightlabs = c(ratetitle,patienttitle),
               
               smlab=sprintf(titleval)
  )
}

svg("/home/thomas/tmp/psa_response.svg",width = 18, height=36,pointsize=12,onefile = T)
makefig(totDF %>% rename(num_response = num_response.x, num_patients=num_patients.x, color=lcolor),"PSA Response","rate","patients")
dev.off()
svg("/home/thomas/tmp/rad_response.svg",width = 18, height=36,pointsize=12,onefile = T)
makefig(totDF %>% rename(num_response = num_response.y, num_patients=num_patients.y, color=rcolor),"RAD Response","rate","patients")
dev.off()
```

### Appendix Enrichment maxes

```{r}
top.rr <- spop_ratio %>% left_join(biomarker.names %>% rename(biomarker.short = name),by="biomarker") %>% 
  mutate(biomarker = ifelse(is.na(biomarker.short),biomarker,biomarker.short)) %>% 
  mutate(biomarker = ifelse(biomarker=="none","not given",biomarker)) %>% 
  filter(!(outcome_type %in% c("radiographic progression","death"))) %>% 
  mutate(color = ifelse(!biomarker_positive %in% c("","positive"),"firebrick3","green")) %>% 
  mutate(biomarker_modifier = ifelse(biomarker_modifier %in% c("mutated","altered","qualifying or suspected deleterious alteration","NA"),"", biomarker_modifier)) %>% 
  mutate(treatment = ifelse(treatment == "AAP or Enz;crossover to olaparib permitted","AAP or Enz",treatment)) %>% 
  mutate(treatment = ifelse(treatment == "enzalutamide + pembrolizumab","Enz + Pem",treatment)) %>% 
  mutate(outcome_type = ifelse(grepl(";",outcome_type),"composite",outcome_type)) 

rr.max <- top.rr %>% 
  group_by(short_name) %>% filter(conf.min == max(conf.min)) %>% ungroup() %>% arrange(-conf.min) %>% 
  select(biomarker,num_response,num_patients,short_name,biomarker_modifier,biomarker_positive,treatment,rate,outcome_type,color) %>% distinct() %>% 
  mutate(row = row_number())

rr.min <- top.rr %>% 
  group_by(short_name) %>% filter(conf.max == min(conf.max)) %>% ungroup() %>% arrange(conf.max) %>% 
  select(biomarker,num_response,num_patients,short_name,biomarker_modifier,biomarker_positive,treatment,rate,outcome_type,color) %>% distinct() %>% 
  mutate(row = row_number())

makeplot <- function(df,title){
  m.gen <- meta::metaprop(
    event    = num_response,
    n        = num_patients,
    studlab  = biomarker,
    data     = df)
  
  color <- df$color
  row <- df$row
  meta::forest(m.gen,
               sortvar = row,
               subgroup = T,
               print.subgroup.labels = T,
               xlim=c(0.0,1.0),
               # col.study = color,
               # col.square = color,
               # col.square.lines = "black",
               
               # studlab = T,
               comb.fixed = F,
               comb.random = F,
               leftlabs  = c("short_name","biomarker","biomarker_modifier","treatment","type"),
               leftcols  = c("short_name","biomarker","biomarker_modifier","treatment","outcome_type"),
               rightcols = c("rate","num_patients"),
               # rightlabs = c(ratetitle,patienttitle),
               
               smlab=title
  )
}

makeplot(rr.max,"strongest response")
makeplot(rr.min,"weakest response")
```

### Appendix best/worst Survival Times

```{r}
top.surv <- spop_outcome %>% 
  rename(biomarker = int_biomarker, biomarker_modifier = int_bm_mod) %>% 
  left_join(biomarker.names %>% rename(biomarker.short = name),by="biomarker") %>% 
  mutate(biomarker = ifelse(is.na(biomarker.short),biomarker,biomarker.short)) %>% 
  mutate(biomarker = ifelse(biomarker=="none","not given",biomarker)) %>% 
  filter(!(outcome_type %in% c("radiographic progression","death"))) %>% 
  mutate(biomarker_modifier = ifelse(biomarker_modifier %in% c("mutated","altered","qualifying or suspected deleterious alteration","NA"),"", biomarker_modifier)) %>% 
  mutate(treatment = ifelse(treatment == "AAP or Enz;crossover to olaparib permitted","AAP or Enz",treatment)) %>% 
  mutate(treatment = ifelse(treatment == "enzalutamide + pembrolizumab","Enz + Pem",treatment)) %>% 
  mutate(outcome_type = ifelse(grepl(";",outcome_type),"composite",outcome_type)) 

surv.max <- top.surv %>% 
  group_by(short_name) %>% filter(conf.min == max(conf.min)) %>% ungroup() %>% arrange(-conf.min) %>% 
  select(biomarker,num_response,num_patients,short_name,biomarker_modifier,biomarker_positive,treatment,rate,outcome_type,color) %>% distinct() %>% 
  mutate(row = row_number())

rr.min <- top.rr %>% 
  group_by(short_name) %>% filter(conf.max == min(conf.max)) %>% ungroup() %>% arrange(conf.max) %>% 
  select(biomarker,num_response,num_patients,short_name,biomarker_modifier,biomarker_positive,treatment,rate,outcome_type,color) %>% distinct() %>% 
  mutate(row = row_number())

makeplot <- function(df,title){
  m.gen <- meta::metaprop(
    event    = num_response,
    n        = num_patients,
    studlab  = biomarker,
    data     = df)
  
  color <- df$color
  row <- df$row
  meta::forest(m.gen,
               sortvar = row,
               subgroup = T,
               print.subgroup.labels = T,
               xlim=c(0.0,1.0),
               # col.study = color,
               # col.square = color,
               # col.square.lines = "black",
               
               # studlab = T,
               comb.fixed = F,
               comb.random = F,
               leftlabs  = c("short_name","biomarker","biomarker_modifier","treatment","type"),
               leftcols  = c("short_name","biomarker","biomarker_modifier","treatment","outcome_type"),
               rightcols = c("rate","num_patients"),
               # rightlabs = c(ratetitle,patienttitle),
               
               smlab=title
  )
}

makeplot(rr.max,"strongest response")
makeplot(rr.min,"weakest response")
```


## Fig 3 - Simple Models

```{r cache=T}
cDF  <- lapply(names(clinDF),function(name){clinDF[[name]] %>% mutate(trial=name)}) %>% 
  dplyr::bind_rows() %>% 
  select(trial,patient_id, pfs=pfs_months, censored, treatment)

bDF  <- dplyr::bind_rows(biomDF) %>% 
  mutate(value = ifelse(value %in% c("none","normal","FALSE","WT"),"normal",ifelse(is.na(value),"normal","altered"))) %>% 
  inner_join(cDF,by="patient_id") %>% 
  mutate(variable = as.character(variable)) %>% 
  mutate(treatment = ifelse(treatment == "abiraterone", "AAP",treatment)) %>% 
  mutate(treatment_class = ifelse(treatment %in% c("AAP","enzalutamide"),"ARD","PARPi"))

modelDF <- bDF %>% 
  reshape2::dcast(patient_id + pfs + censored + treatment + trial + treatment_class ~ variable,value.var="value") %>% 
  mutate(progressed = ifelse(censored == "progressed",1,0)) %>% 
  mutate_at(vars(-patient_id,-pfs,-censored,-trial,-progressed),as.factor) %>% 
  select(-censored) %>% rename(NKX3_1 = `NKX3-1`)

cox <- function(y, x, start = NULL, weights = NULL, offset = NULL, ... ) {
  x <- x[, -1]
  coxph(formula = y ~ x)
}


# simple function to generate ggparty plots
party_node <- function(data,mapping){
  data$pfs = data[,'Surv(pfs, progressed).time']
  data$progressed = data[,'Surv(pfs, progressed).status']
  HR = coxph(Surv(pfs,progressed) ~ treatment_class,data=data) %>% getHazardRatio(digits=2)
  pats = nrow(data)
  ggplot(data,aes_string(time="pfs",status="progressed",color="treatment_class")) + geom_km() + 
    theme(legend.position="none") + xlab("") + ylab("")
}

mob_partyfn <- function(mobmod,survname){
  
  splitLabs = apply(ggparty(mobmod)$data,1,function(row){
    il = row$info_list
    sprintf("%s-%s\nHR=%s",row$splitvar,il$nobs,il$object %>% getHazardRatio(digitsval = 2))
  })
  
  HRS <- lapply(ggparty(mobmod)$data$info_list,function(il){
    sprintf("n=%s HR=%s",il$nobs,il$object %>% getHazardRatio(digitsval = 2))
  })
  
  ggparty(mobmod) +
    geom_edge() +
    geom_edge_label(size=3) +
    geom_node_label(size=3,aes(label = splitLabs), ids = "inner") +
    geom_node_plot(plot_call = "party_node",gglist=list(),ids = "terminal",shared_axis_labels = T,shared_legend=F) +
    geom_node_label(size=3,aes(label = HRS),
                    fontface = "bold",
                    ids = "terminal",
                    nudge_y = 0.01,nudge_x = 0.015) 
}
```

### 3A Simple combined model
1. why so many NAs in the triton set? - triton2-2 goofs this
2. why only 9 cdk12 in chidf? - that's just the way it is

```{r cache=T}
library(tidyr)

comb.train = modelDF %>% filter(trial == "chinnaiyan" | trial == "chi")

comb.highcount <- comb.train %>% 
  select(-treatment) %>% 
  melt(id.vars=c("patient_id","pfs","treatment_class","progressed","trial")) %>%
  mutate(variable=as.character(variable)) %>% 
  filter(!is.na(value)) %>% 
  group_by(variable,value,treatment_class) %>% 
  summarise(measured = n(),n_trials=n_distinct(trial),trials=paste(unique(trial),collapse=",")) %>% ungroup() %>% 
  group_by(variable) %>% 
  summarise(mincount = min(measured),dist_val = n_distinct(value,treatment_class),trials=max(n_trials)) %>% 
  ungroup() %>% 
  filter(mincount>9,dist_val==4,trials==2) %>% 
  arrange(-mincount)

comb.highcount.genes = unique(comb.highcount$variable)
comb.highcount %>% group_by(variable) %>% summarize(mincount = min(mincount))

formula = as.formula(sprintf("Surv(pfs,progressed) ~ treatment_class | %s",paste(comb.highcount.genes,collapse="+")))
mb  <- mob(formula = formula, data = comb.train, fit=cox,control = mob_control(bonferroni = F,alpha=1.0,minsize = 15,maxdepth = 5))
res <- mob_partyfn(mb)
fig3A <- res 
```

```{r cache=T}
bDF %>% group_by(variable,value,treatment_class) %>% count() %>% ungroup() %>% 
  complete(variable,value,treatment_class,fill=list(n=0)) %>% 
  group_by(variable) %>% summarize(min_patients = min(n)) %>% 
  filter(min_patients > 10)

mdf2.1 <- modelDF %>% select(-treatment,-any) %>% 
  mutate_at(vars(-patient_id,-pfs,-progressed,-treatment_class,-trial),.funs=as.character) %>%
  mutate_at(vars(-patient_id,-pfs,-progressed,-treatment_class,-trial),.funs=~ifelse(is.na(.),"normal",.)) %>% 
  mutate(`cell_cycle` = ifelse(TP53=="altered" | RB1=="altered" | MDM2=="altered" | CDKN2A=="altered" | 
                                 MYC=="altered" | CCND1=="altered","altered","normal")) %>% 
  mutate(`PI3K_pathway` = ifelse(PTEN=="altered" | PIK3R1=="altered" | PIK3CA=="altered" | 
                                   PIK3CB=="altered" | AKT1=="altered","altered","normal")) %>% 
  mutate(`WNT_pathway` = ifelse(APC=="altered" | CTNNB1=="altered" | RNF43=="altered","altered","normal")) %>% 
  mutate(`DNA_repair` = ifelse(BRCA2=="altered" | BRCA1=="altered" | ATM=="altered" | CDK12=="altered" | MSH2=="altered" | 
                                 MSH6=="altered" | MLH1 == "altered" | FANCA == "altered","altered","normal")) %>% 
  mutate(`AR_associated` = ifelse(FOXA1=="altered" | FOXP1=="altered" | ZBTB16=="altered" | AR == "altered","altered","normal")) %>% 
  mutate(`Chromatin_modifiers` = ifelse(KMT2C=="altered" | KMT2D=="altered" | CHD1=="altered" | KDM6A=="altered","altered","normal"))

anyDF <- mdf2.1 %>% data.table::setDT() %>% 
  melt(id.vars=c("patient_id","pfs","treatment_class","progressed","trial")) %>% 
  group_by(patient_id) %>% summarise(any = ifelse(sum(value == "altered",na.rm = T)>2,"altered","normal")) %>% ungroup()

mdf2 <- mdf2.1 %>% inner_join(anyDF,by="patient_id")  %>%
  mutate_at(vars(-patient_id,-pfs,-progressed,-treatment_class,-trial),.funs=as.factor) 

highcount <- mdf2 %>% 
  data.table::setDT() %>% 
  melt(id.vars=c("patient_id","pfs","treatment_class","progressed","trial")) %>% 
  group_by(variable,value,treatment_class) %>% summarize(patients=n_distinct(patient_id)) %>% ungroup() %>%
  complete(variable,value,treatment_class,fill=list(patients=0)) %>% 
  group_by(variable) %>% summarize(min_patients = min(patients)) %>% 
  arrange(min_patients) %>% 
  filter(min_patients > 10)

highcount.genes <- setdiff(unique(highcount$variable),c("DRD","HRDc","DRD_del"))
highcount.genes
formula = as.formula(sprintf("Surv(pfs,progressed) ~ treatment_class | %s",paste(highcount.genes,collapse=" + ")))

risks <- list()
models <- list()

pb <- progress::progress_bar$new(total=10)
for(i in 1:10){
  pb$tick()
  mb  <- mob(formula = formula,data=mdf2,fit=cox,
             control = mob_control(bonferroni = F,alpha=1.0,minsize = 5,mtry = 5))
  res <- mob_partyfn(mb)
  
  nod  <- predict.party(mb,mdf2,type="node")
  HRDF <- lapply(res$data$info_list,function(il){(il$object %>% getHazardRatioNum())$HR}) %>% unlist()
  models[[i]] = mb
  risks[[i]] = round(HRDF[nod],3)
}

m <- do.call(cbind,risks) %>% (function(m){m[which(m>100)]<-NA;m})
result <- mdf2
result$risk <- do.call(cbind,risks) %>% (function(m){m[which(m>7)]<-NA;m}) %>%  rowMeans(na.rm = T) + rnorm(n=nrow(mdf2))/1000

r = result %>% group_by(risk) %>% count() %>% mutate(pr = n/nrow(mdf2)) %>% ungroup() %>% arrange(risk) %>% mutate(cumn = cumsum(n),cump = cumsum(pr))
lorisk = (r %>% filter(cump > 0.275) %>% arrange(risk))$risk[1] + 0.0001
merisk = (r %>% filter(cump > 0.66) %>% arrange(risk))$risk[1] + 0.0001
r
lorisk

# cache the result so we can stop rebuilding.
# save.image("./cache.obj/mobforest.image")

plotDF <- result %>% 
  mutate(BRCA2 = ifelse(BRCA2=="altered","PARPi strong preference","no preference")) %>% 
  mutate(model = ifelse(risk < lorisk,"PARPi strong preference",ifelse(risk<merisk,"PARPi weak preference","no preference"))) %>% 
  select(BRCA2,model,pfs,progressed,treatment_class,risk) %>% 
  data.table::setDT() %>% 
  melt(id.vars=c("pfs","progressed","treatment_class","risk")) %>% 
  mutate(value = factor(value,levels=c("no preference","PARPi weak preference","PARPi strong preference"))) %>% 
  mutate(coxHR = case_when(
    variable=="BRCA2" & value == "PARPi strong preference" ~ 
      coxph(Surv(pfs,progressed)~treatment_class,result %>% filter(BRCA2=="altered")) %>% getHazardRatio(digitsval = 2),
    variable=="BRCA2" & value == "no preference" ~ 
      coxph(Surv(pfs,progressed)~treatment_class,result %>% filter(BRCA2!="altered")) %>% getHazardRatio(digitsval = 2),
    variable=="model" & value == "PARPi strong preference" ~ 
      coxph(Surv(pfs,progressed)~treatment_class,result %>% filter(risk < lorisk)) %>% getHazardRatio(digitsval = 2),
    variable=="model" & value == "PARPi weak preference" ~ 
      coxph(Surv(pfs,progressed)~treatment_class,result %>% filter(risk < merisk, risk > lorisk)) %>% getHazardRatio(digitsval = 2),
    variable=="model" & value == "no preference" ~ 
      coxph(Surv(pfs,progressed)~treatment_class,result %>% filter(risk>=merisk)) %>% getHazardRatio(digitsval = 2)
  )) %>% mutate(coxHR = sprintf("HR = %s",coxHR)) %>% 
  group_by(variable,value) %>% mutate(prev = n()/nrow(m)) %>% ungroup() %>% mutate(text = sprintf("%s\nprev=%.1f%%",coxHR,prev*100))

fig3D <- ggplot(plotDF,aes(time=pfs,status=progressed,color=treatment_class)) + 
  geom_km() + geom_kmticks() + geom_kmband() + 
  geom_text(data=plotDF %>% select(variable,value,text) %>% distinct() %>%
              mutate(pfs=1,progressed=1,x=20,y=0.8),aes(x=x,y=y,label=text),color="black") + 
  facet_grid(variable~value) + theme_bw() + ylab("")  + xlab("")
fig3D
```


### 3B Chinnaiyan
```{r cache=T}
chinn.train = modelDF %>% filter(trial=="chinnaiyan") %>% mutate(treatment_class=treatment)
chinn.highcount <- chinn.train %>% 
  select(-treatment_class,-trial) %>% 
  melt(id.vars=c("patient_id","pfs","treatment","progressed")) %>%
  mutate(variable=as.character(variable)) %>% 
  filter(!is.na(value)) %>% 
  group_by(variable,value,treatment) %>% 
  summarise(measured = n()) %>% ungroup() %>% 
  group_by(variable) %>% 
  mutate(mincount = min(measured),dist_val = n_distinct(value,treatment)) %>% ungroup() %>% 
  filter(dist_val==4,mincount>10) %>%
  arrange(-mincount)

chinn.genes = unique(chinn.highcount$variable)
chinn.genes
formula = as.formula(sprintf("Surv(pfs,progressed) ~ treatment_class | %s",paste(chinn.genes,collapse="+")))
mb2 <- mob(formula = formula, data = chinn.train, fit=cox,control = mob_control(bonferroni = F,alpha=1.0,minsize = 20))
fig3B <- mob_partyfn(mb2) 
```

### 3D Building populations
Which populations benefit from PARPi who don't have a BRCA2 mutation? who don't have an HRD mutation?
```{r}
HRD.vs.model <- result %>%  
  mutate(`HRD/DRD` = ifelse(BRCA2=="altered" | BRCA1=="altered" | ATM=="altered" | CDK12=="altered" | MSH2=="altered" | 
                                 MSH6=="altered" | MLH1 == "altered" | FANCA == "altered","HRD","NO HRD")) %>% 
  mutate(risk = ifelse(risk < 0.63,"model prefers PARP-i","model no preference"))

HR1 = coxph(Surv(pfs,progressed)~treatment_class,
            HRD.vs.model %>% filter(`HRD/DRD` == "HRD",risk=="model prefers PARP-i")) %>%
  getHazardRatio(digitsval = 2)

HR2 = coxph(Surv(pfs,progressed)~treatment_class,
            HRD.vs.model %>% filter(`HRD/DRD` == "NO HRD",risk=="model prefers PARP-i")) %>%
  getHazardRatio(digitsval = 2)

HR3 = coxph(Surv(pfs,progressed)~treatment_class,
            HRD.vs.model %>% filter(`HRD/DRD` == "HRD",risk=="model no preference")) %>%
  getHazardRatio(digitsval = 2)

HR4 = coxph(Surv(pfs,progressed)~treatment_class,
            HRD.vs.model %>% filter(`HRD/DRD` == "NO HRD",risk=="model no preference")) %>%
  getHazardRatio(digitsval = 2)

HRD.vs.model.HR = HRD.vs.model %>% mutate(HR = case_when(
  `HRD/DRD` == "HRD" & risk=="model prefers PARP-i" ~ HR1, 
  `HRD/DRD` == "NO HRD" & risk=="model prefers PARP-i" ~ HR2,
  `HRD/DRD` == "HRD" & risk=="model no preference"  ~ HR3,
  `HRD/DRD` == "NO HRD" & risk=="model no preference"  ~ HR4
  )) %>% mutate(HR = sprintf("HR = %s",HR))

fig3C <- ggplot(HRD.vs.model,aes(time=pfs,status=progressed,col=treatment_class)) + 
  geom_km() + geom_kmticks() +  geom_kmband() +
  geom_text(data=HRD.vs.model.HR %>% select(`HRD/DRD`,risk,HR) %>% distinct() %>%
              mutate(pfs=1,progressed=1,x=20,y=0.8),aes(x=x,y=y,label=HR),color="black") +
  facet_grid(`HRD/DRD`~risk) + theme_bw() + 
  xlab("") + ylab("") + theme(legend.position = "none")
fig3C

fig3A.clip <- wrap_elements(full = fig3A, clip = T)
fig3B.clip <- wrap_elements(full = fig3B, clip = T)
fig3C.clip <- wrap_elements(full = fig3C, clip = T)

(fig3A.clip + fig3B.clip + fig3D  + fig3C) + 
  plot_layout(nrow=2,ncol=2,heights=c(2,1),widths=c(3,2),guides="collect") +
  plot_annotation(tag_levels=list(c("A","B","C","D"))) & theme(legend.title = element_blank(),legend.position='bottom')

ggsave("./figures/mobforest.svg",width = 20,height=10,units = "in",limitsize = F)

```

## Fig 5 Adverse Events

### Appendix A1 - CT.Gov Evaluation
```{r}
raw.aeDF <- {
  con <- dbConnect(dbDriver('PostgreSQL'), dbname="aact",
                   host="aact-db.ctti-clinicaltrials.org", port=5432,
                   user="tomlue", password="s2bfr7acdjHJYh3")
  trials <- sprintf("('%s')",paste(HRD.baseDF$trial,collapse="','"))
  query <- sprintf("SELECT rg.title,rg.description rg_desc,re.* FROM reported_events re inner join 
                                result_groups rg on re.result_group_id = rg.id WHERE re.nct_id in %s",trials)
  df2 <- dbGetQuery(con,query)
  dbDisconnect(con)
  df2 %>% rename(trial=nct_id)
}


ctgovhaz = range_read(extractions_sheet,sheet = "ctgovhazard") %>% filter(include=="T")
short.organ = range_read(extractions_sheet,sheet = "short-organ-system")

ct.aeDF <- raw.aeDF %>% 
  mutate(adverse_event_term = tolower(adverse_event_term)) %>% 
  inner_join(ctgovhaz,by="title") %>% 
  inner_join(short.organ,by="organ_system") %>% 
  mutate(rate = subjects_affected / subjects_at_risk) %>% 
  select(rg_name,order,treatment_class,event_type,organ_system=short_organ,
         event=adverse_event_term,subjects_affected,subjects_at_risk,rate) 

plotA <- ct.aeDF %>% 
  group_by(rg_name,order,treatment_class,organ_system,event_type) %>% summarize(rate=median(rate)) %>% ungroup() %>% 
  complete(nesting(rg_name,order,event_type),organ_system,treatment_class) %>% 
  group_by(organ_system) %>% mutate(event.total = sum(rate,na.rm = T)) %>% ungroup() %>% 
  mutate(rate_bucket = ifelse(rate==0,"0%",ifelse(rate>0.2,"20%+",ifelse(rate>0.1,"10%-20%",ifelse(rate>0,"0%-10%",NA))))) %>% 
  mutate(rate_bucket = factor(rate_bucket,levels=c("0%","0%-10%","10%-20%","20%+")))

colfunc <- colorRampPalette(c("green", "red"))
A <- ggplot(plotA,aes(y=reorder(rg_name,-order),x=reorder(organ_system,-event.total),fill=rate_bucket)) + 
  geom_tile(col="black") + facet_grid(event_type ~ treatment_class) +
  xlab("") + ylab("") + 
  theme(axis.text.x = element_text(angle=45,hjust=1), legend.position = "left") + 
  scale_fill_manual(values =colfunc(4))
A
plotB <- plotA %>% group_by(rg_name,treatment_class,order,event_type) %>% summarize(rate=sum(rate,na.rm = T))
B <- ggplot(plotB,aes(x=reorder(rg_name,-order),y=rate,fill=treatment_class)) + coord_flip() + 
  geom_col(position = "dodge") + scale_y_continuous(expand=c(0,0)) + facet_grid( event_type ~ .) +
  theme_bw() + theme(legend.position = "right") + xlab("") + ylab("")
B

plotC <- plotA %>% group_by(organ_system,event.total,event_type,treatment_class) %>% summarize(rate=median(rate,na.rm=T))
C <- ggplot(plotC,aes(x=reorder(organ_system,-event.total),y=rate,fill=event_type)) +
  geom_col() + scale_y_continuous(expand=c(0,0)) + facet_grid( ~ treatment_class) +
  theme_bw() + theme(legend.position = "left",axis.text.x = element_blank()) + xlab("") + 
  scale_fill_manual(values=c("darkturquoise","firebrick3"))

C + plot_spacer() + A + B + plot_layout(heights = c(1,2),widths = c(2.5,1)) + plot_annotation(tag_levels = 'A')
ggsave("./figures/AE-ctgov.svg",width = 20,height=10,units = "in")
```

### BAWTO Evaluation
```{r}

bawto2hrd <- range_read(extractions_sheet,sheet = "bawto_to_hrd",col_types = 'c') %>% 
  select(bawto.article.id,Article.ID=hrd.2.article.id) %>% 
  mutate_at(vars(bawto.article.id,Article.ID),as.numeric)

bawtoGL  <- RSysrev::sysrev.getGroupLabelAnswers(70431) %>% lapply(function(df){
  df %>% rename(bawto.article.id = Article.ID) %>% left_join(bawto2hrd)
})

AE.names <- range_read(extractions_sheet,sheet = "short-ae-name",col_types = 'c')
bawtoAE.names <- range_read(extractions_sheet,sheet = "bawto-pop-int-names",col_types = 'c') %>% 
  mutate(Article.ID = as.numeric(Article.ID)) %>% 
  filter(include != "F")

bawtoAE  <- bawtoGL$`Adverse Events` %>% 
  inner_join(HRD.baseDF %>% select(Article.ID,short_name),by="Article.ID") %>%
  filter(User.Name %in% c("tbozada1","tom")) %>% 
  inner_join(bawtoAE.names,by=c("Article.ID","Pop_ID","Int_ID","short_name")) %>% 
  mutate_at(vars(AE_Value,experiment_num_patients,order),as.numeric) %>% 
  mutate_at(vars(Adverse_Event,Grade),trimws) %>% 
  mutate(rate = AE_Value / experiment_num_patients)

AE.countDF <- bawtoAE %>% 
  filter(!is.na(Grade),Grade != "",Adverse_Event != "maximum grad for patient") %>% 
  select(rg_name,order,treatment_class,experiment_num_patients,Adverse_Event,Grade,AE_Value) %>% 
  reshape2::dcast(rg_name + order + treatment_class + experiment_num_patients + Adverse_Event ~ Grade,value.var="AE_Value",
        fun.aggregate=first,fill=NA_real_) %>% 
  rowwise() %>% 
  mutate(serious = sum(`3`,`4`,`3; 4`,na.rm = T)) %>% 
  mutate(serious = max(serious,`3; 4; Severe AE (SAE)`,`Severe AE (SAE)`,na.rm=T)) %>% 
  mutate(non_serious = sum(`1`,`2`,na.rm=T)) %>% 
  mutate(non_serious = max(non_serious,`1; 2`,na.rm=T)) %>% 
  mutate(any = `any grade`) %>% 
  mutate(any = ifelse(is.na(any),serious+non_serious,any)) %>% 
  ungroup() %>% 
  mutate(`grade 1/2` = any-serious) %>% 
  mutate(`grade 3+` = serious) %>% 
  select(rg_name,order,treatment_class,patients=experiment_num_patients,event=Adverse_Event,`grade 1/2`, `grade 3+`) %>% 
  reshape2::melt(id.vars = c("rg_name","order","treatment_class","patients","event"),
       variable.name="grade",value.name = "affected") %>% 
  mutate(rate = affected / patients) %>% 
  filter(patients > 20,event != "Any AE") %>% 
  mutate(event = ifelse(event == "asthenia","asthenia/fatigue",event)) %>% 
  mutate(event = ifelse(event == "fatigue","asthenia/fatigue",event)) %>% 
  mutate(event = ifelse(event == "pneumonitis","pneumonia",event)) %>% 
  mutate(event = ifelse(event == "thrombocytopenia","platelet count decreased",event))

rg_name_treatments = AE.countDF %>% 
  select(rg_name,treatment_class) %>% 
  distinct() %>% mutate(has_treatment=T) %>% 
  complete(rg_name,treatment_class,fill=list(has_treatment=F))

ev.studies <- AE.countDF %>% group_by(event) %>% summarize(ev.studies = n_distinct(rg_name)) %>% ungroup()
anyDF <- AE.countDF %>% 
  complete(nesting(rg_name,order),treatment_class,grade,event) %>% 
  group_by(rg_name) %>% mutate(tot = sum(rate,na.rm = T)) %>% ungroup() %>% 
  group_by(event) %>% mutate(
    tot_rate = sum(rate,na.rm=T),
    event_tot = sum(rate>0,na.rm=T),
    med_rate = median(rate,na.rm=T),
    mean_rate = mean(rate,na.rm=T)
    ) %>% 
  ungroup() %>% 
  inner_join(rg_name_treatments,by=c("rg_name","treatment_class")) %>% 
  inner_join(ev.studies,by="event") %>% 
  # filter(event_tot > 5,treatment_class != "immunotherapy") %>% 
  filter(ev.studies > 3,treatment_class != "immunotherapy") %>% 
  mutate(rate_bucket = case_when(
    !has_treatment ~ "no treatment",
    rate > 0.2 ~ "20%+",
    rate > 0.1 ~ "10%-20%",
    rate > 0   ~ "0%-10%",
    rate == 0  ~ "0%",
    is.na(rate) ~ "no record")) %>% 
  mutate(rate_bucket = factor(rate_bucket,levels=c("0%","0%-10%","10%-20%","20%+","no record","no treatment")))
  
axis.text.size = unit(11,"pt") 
strip.text.size = unit(14,"pt")

colfunc <- colorRampPalette(c("green", "red"))
B <- ggplot(anyDF,aes(y=reorder(rg_name,-order),x=reorder(event,-mean_rate),fill=rate_bucket)) + 
  geom_tile(col="black") + facet_grid(grade ~ treatment_class) + 
  xlab("") + ylab("") + 
  theme(axis.text.y = element_text(size = axis.text.size),
        axis.text.x = element_text(angle=45,hjust=1,size=axis.text.size),
        strip.text = element_text(size=strip.text.size)) + 
  scale_fill_manual(values=c(colfunc(4),"darkgray","purple"),
                    guide= guide_legend(title="B. rate",title.position = "top",direction="horizontal",nrow=2))
B
plotB <- anyDF %>% 
  inner_join(AE.names) %>% 
  group_by(event,short_ae_name,mean_rate,grade,treatment_class) %>% 
  summarize(rate=median(rate,na.rm=T)) %>% 
  group_by(event) %>% mutate(event_num = row_number()) %>% ungroup()

A <- ggplot(plotB,aes(x=reorder(short_ae_name,-mean_rate),y=rate,fill=grade)) + geom_col() + 
  scale_y_continuous(expand=c(0,0)) + facet_grid( ~ treatment_class) + 
  scale_fill_manual(values=c("darkturquoise","firebrick3"),
                    guide= guide_legend(title = "A. grade", title.position = "top",direction="horizontal")) + 
  theme_bw() + xlab("") + ylab("") + 
  theme(axis.text.y = element_text(size=axis.text.size),
        axis.text.x = element_text(angle=45,hjust=1),
        strip.text  = element_text(size=strip.text.size))  
A

plotC <- AE.countDF %>% filter(event=="anemia")
grade_names <- list("grade 1/2" = "anemia\ngrade 1/2","grade 3+" = "anemia\ngrade 3+")
grade_labeller <- function(value){return(grade_names[value])}

C <- ggplot(plotC,aes(x=reorder(rg_name,-order),y=rate,fill=treatment_class)) + geom_col(position="dodge") + coord_flip() + 
  theme_bw() + 
  facet_grid( grade ~.,labeller=as_labeller(grade_labeller)) + 
  scale_y_continuous(expand=c(0,0)) + 
  scale_fill_discrete(guide=guide_legend(title="C. treatment class",title.position = "top",direction="horizontal")) + 
  xlab("") + ylab("") + 
  theme(
        axis.text.x = element_text(size=axis.text.size),
        axis.text.y = element_text(size=axis.text.size),
        strip.text  = element_text(size=strip.text.size),
        ) 
C
A + guide_area() + B + C + plot_layout(heights = c(1,2),widths = c(3,1),guides = "collect") + plot_annotation(tag_levels='A')
ggsave("./figures/adverse_events.svg",width = 20,height=10,units = "in",limitsize = F)

```


## Appendix - KN Chi + Chinnaiyan ARD and HRD

```{r}
# TODO this is incomplete
plotDF <- chiDF %>% mutate(progressed = ifelse(progressed,1,0))
ggplot(plotDF,aes(time=PFS,status=progressed,col=ATM)) + geom_km()

plotDF2 <- chinnDF %>% mutate(progressed = ifelse(censored,0,1)) %>% filter(treatment == "AAP")
ggplot(plotDF2,aes(time=PFS,status=progressed,col=DRD_del)) + geom_km()
```

# Statements

## Abstract

```{r}
# SELECT min(study_first_posted_date),count(distinct s.nct_id)
# FROM studies s
# inner join outcomes o on o.nct_id = s.nct_id
# inner JOIN eligibilities e on e.nct_id = s.nct_id
# inner JOIN conditions c on c.nct_id = s.nct_id
# inner JOIN interventions i on i.nct_id = s.nct_id
# where
#       s.study_type = 'Interventional'
#   AND c.downcase_name ilike '%cancer%'
#   AND i.intervention_type = 'Drug' AND
#       (O.title ilike '%biomarker%' OR O.description ilike '%biomarker%' OR e.criteria ilike '%biomarker%');
# 
# SELECT distinct (c.nct_id, s.official_title,study_first_posted_date,o.title)
# FROM studies s
# inner join outcomes o on o.nct_id = s.nct_id
# inner JOIN eligibilities e on e.nct_id = s.nct_id
# inner JOIN conditions c on c.nct_id = s.nct_id
# inner JOIN interventions i on i.nct_id = s.nct_id
# where
#       s.study_type = 'Interventional'
#   AND c.downcase_name ilike '%cancer%'
#   AND i.intervention_type = 'Drug' AND study_first_posted_date = '2003-11-17';
# 
# -- up 511 2003-11-27 (with mutation)
# -- down 3975
# SELECT count(distinct c.nct_id) FROM studies s
# inner join outcomes o on o.nct_id = s.nct_id
# inner JOIN eligibilities e on e.nct_id = s.nct_id
# inner JOIN conditions c on c.nct_id = s.nct_id
# inner JOIN interventions i on i.nct_id = s.nct_id
# where s.study_type = 'Interventional'
#   AND study_first_posted_date > '2003-11-27'
#   AND c.downcase_name ilike '%cancer%'
#   AND i.intervention_type = 'Drug';
# 
# 
# SELECT distinct(intervention_type) FROM interventions;

```
## Results 

### Biomarker Eligibility

#### Unstudied genes
```{r}
library(msigdbr)

gs <- msigdbr(species="Homo sapiens") %>% filter(gs_name %in% c(
  "KEGG_HOMOLOGOUS_RECOMBINATION",
  "WP_HOMOLOGOUS_RECOMBINATION",
  "REACTOME_HDR_THROUGH_HOMOLOGOUS_RECOMBINATION_HRR"
))

length(unique(gs$ensembl_gene))
newgenes <- gs %>% filter(!(human_gene_symbol %in% DRD)) %>% 
  group_by(entrez_gene,human_gene_symbol) %>% count() %>% 
  arrange(-n)
genes <- setdiff(DRD,unique(gs$human_gene_symbol))
```

### Adverse Events
```{r}
# of those 113 distinct adverse events 17 were reported in 3 or more trials and shown in figure 5. 
length(unique(AE.countDF$event))
length(unique(plotB$event))

# The rate of serious grade 3+ adverse events was less than 11% in all ARD populations for all event types
AE.countDF %>% filter(treatment_class == "ARD",grade == "grade 3+") %>% 
  arrange(-rate) %>% select(rg_name,event,rate,affected,patients) %>% head()

# asthenia was the most common event in all populations except moran
AE.countDF %>% filter(treatment_class == "ARD") %>% group_by(rg_name,treatment_class,patients,event) %>% 
  summarize(affected = sum(affected)) %>% mutate(rate = affected / patients) %>% 
  select(rg_name,event,rate,affected,patients) %>% group_by(rg_name) %>% top_n(1,rate) %>% ungroup()

# Anemia was the most common serious adverse event (>15%) in all PARP-i populatinos except chinnaiyan
AE.countDF %>% filter(treatment_class == "PARPi",grade=="grade 3+") %>% 
  select(rg_name,event,rate,affected,patients) %>% group_by(rg_name) %>% top_n(1,rate) %>% ungroup()

AE.countDF %>% filter(treatment_class == "PARPi",grade=="grade 3+",event=="platelet down") %>% 
  select(rg_name,event,rate,affected,patients)

# serious PARPi events
AE.PARPi <- AE.countDF %>% 
  filter(treatment_class == "PARPi") %>% arrange(-rate) %>%
  select(rg_name,grade,event,rate,affected,patients) %>% data.table::setDT()

# AE dose dependence
AE.PARPi %>% filter(grepl("TOPARP-A",rg_name),affected>2) %>% filter(grade == "grade 3+") %>% 
  dcast(event ~ rg_name,value.var="rate",fill = 0) %>% 
  mutate(diff = `TOPARP-A-400` - `TOPARP-A-300`) %>% arrange(-diff)

AE.ARD.vs.PARPi <- AE.countDF %>% 
  filter(treatment_class %in% c("PARPi","ARD")) %>% 
  group_by(rg_name) %>% filter(n_distinct(treatment_class) > 1) %>% ungroup() %>% 
  group_by(rg_name,event,grade,treatment_class) %>% top_n(1,affected) %>% ungroup() %>% 
  data.table::setDT() %>% 
  data.table::dcast(rg_name + event + grade ~ treatment_class,value.var = c("rate","affected","patients"),fill=0) %>%  
  filter(patients_ARD > 0, patients_PARPi >0) %>% 
  filter(rg_name != "PROfound-1") %>% 
  inner_join(AE.names) %>% select(-event) %>% rename(event=short_ae_name)


df1 <- AE.ARD.vs.PARPi %>% 
  group_by(event) %>% 
  summarise_at(vars(affected_ARD,affected_PARPi,patients_ARD,patients_PARPi),.funs = ~sum(.)) %>% 
  mutate(neg_ARD=patients_ARD-affected_ARD,neg_PARPi=patients_PARPi-affected_PARPi) %>% 
  do((function(df){
    tmp = escalc(measure="RD", ai=affected_ARD, bi=neg_ARD, ci=affected_PARPi, di=neg_PARPi, data=df)
    summary(tmp)
  })(.)) %>% 
  select(event,ci.lb,ci.ub) %>% distinct()

topE <- (df1 %>% top_n(5,ci.lb))$event %>% unique()
botE <- (df1 %>% top_n(5,-ci.lb))$event %>% unique()

plotDF.any <- AE.ARD.vs.PARPi %>% 
  group_by(rg_name,event) %>% 
  summarise_at(vars(affected_ARD,affected_PARPi,patients_ARD,patients_PARPi),.funs = ~sum(.)) %>% 
  ungroup() %>% 
  mutate(rate_PARPi = affected_PARPi / patients_PARPi,
         rate_ARD   = affected_ARD   / patients_ARD) %>% 
  filter(event %in% c(topE,botE)) %>% inner_join(df1,by=c("event")) %>% 
  mutate(dif = rate_PARPi - rate_ARD) %>% 
  arrange(ci.lb,-dif) %>% 
  mutate(row = row_number()) %>% 
  mutate(grade = "any")

  
m.gen <- meta::metabin(
  event.c = affected_ARD,
  n.c = patients_ARD,
  event.e = affected_PARPi,
  n.e = patients_PARPi,
  studlab = rg_name,
  sm="RD",
  data=plotDF.any) 

fp1 <- meta::forest.meta(m.gen,sortvar = plotDF.any$row,
                         comb.fixed = F,
                         comb.random = F,
                         leftcols = c("rg_name","event","affected_ARD","affected_PARPi"),
                         leftlabs = c("study","event","affected\nAAP","affected\nPARPi"),
                         smlab="Any Grade\nrisk difference") %>% 
  grid.grabExpr() %>% patchwork::wrap_elements()

plotDF.serious <- AE.ARD.vs.PARPi %>% 
  filter(event %in% c(topE,botE)) %>% inner_join(df1,by=c("event")) %>% 
  filter(grade=="grade 3+") %>% 
  inner_join(plotDF.any %>% select(rg_name,event,row) %>% distinct(),by=c("rg_name","event"))

m.gen2 <- meta::metabin(
  event.c = affected_ARD,
  n.c = patients_ARD,
  event.e = affected_PARPi,
  n.e = patients_PARPi,
  studlab = event,
  sm="RD",
  data=plotDF.serious)

fp2 <- meta::forest.meta(m.gen2,
                         sortvar = plotDF.serious$row,
                         comb.fixed = F,
                         comb.random = F,
                         leftcols = c("affected_ARD","affected_PARPi"),
                         leftlabs = c("Grade 3+\nAAP","Grade 3+\nPARPi"),
                         smlab="Grade 3+\nrisk difference")  %>% 
  grid.grabExpr() %>% patchwork::wrap_elements()

svg("./figures/risk_difference.svg",width = 18,height = 5.25)
fp1 + fp2
dev.off()
ggsave("./figures/risk_difference.svg",width = 18,height=5.25,units = "in")
```

### Simple Models
```{r}
# This tree is built from ? genes
comb.train
```

## Discussion

### Queryable data
```{r}
# What was the longest reported median overall survival time in each trial?
spop_outcome %>% filter(outcome_type=="OS") %>% group_by(short_name) %>% top_n(1,outcome_value) %>% 
  select(outcome_value,outcome_range,int_biomarker,bm_positive,int_bm_mod,short_name) %>% 
  arrange(outcome_value)

# Which PARP-i had the lowest and highest rate of grade 3+ anemia?
AE.countDF %>% filter(event=="anemia") %>% 
  filter(treatment_class=="PARPi",grade=="grade 3+") %>% arrange(rate)

# 
```
# GDC Hazards

## Clinical
Let's start with simple `days_to_death` , `last_follow_up` and treatment
```{r}
# See https://bioconductor.org/packages/release/bioc/vignettes/TCGAbiolinks/inst/doc/clinical.html#Clinical
library(TCGAbiolinks)
query <- GDCquery(project = "TCGA-PRAD",
                  data.category = "Clinical",
                  data.type = "Clinical Supplement",
                  data.format = "BCR Biotab")
GDCdownload(query)
clinical.BCRtab.all <- GDCprepare(query)
names(clinical.BCRtab.all)
df <- clinical.BCRtab.all$clinical_drug_prad
df2 <- clinical.BCRtab.all$clinical_patient_prad %>% select(bcr_patient_uuid,histologic_diagnosis,gleason_score,tumor_level,gender,birth_days_to,clinical_stage,days_to_initial_pathologic_diagnosis,tissue_source_site,tumor_tissue_site)
# 
# df[3:nrow(df),] %>% 
#   select(bcr_patient_uuid,pharmaceutical_therapy_drug_name) %>% 
#   inner_join(df2[3:nrow(df),],by="bcr_patient_uuid") %>% clipr::write_clip()
```

## MAF
```{r}
library(TCGAbiolinks)

maf <- GDCquery_Maf("PRAD", pipelines = "muse") # 

df1 <- maf %>% filter(Entrez_Gene_Id %in% gs$entrez_gene)

df2 <- maf %>% 
  filter(Entrez_Gene_Id %in% gs$entrez_gene) %>% 
  filter(!(Entrez_Gene_Id %in% newgenes$entrez_gene))

df3 <- maf %>% filter(Entrez_Gene_Id %in% newgenes$entrez_gene)

# maf <- read.csv("~/git/co.insilica/OncIndex/web/public/resources/TCGA.GBM.mutect.da904cd3-79d7-4ae3-b6c0-e7127998b3e6.DR-10.0.somatic.maf",sep="\t",skip = 5)
# 
# patient_ids <- clipr::read_clip() # see https://docs.google.com/spreadsheets/d/1vGWt63Uk6A7OUXivvb-8t_ZvXmgnapD6ysiXoQ2-Ciw/edit#gid=1671840835
# patient_tumor <- maf %>% 
#   filter(Hugo_Symbol %in% saadHRD) %>% 
#   select(Tumor_Sample_UUID) %>% distinct() %>% top_n(25) %>% mutate(patient_id = patient_ids)
# 
# sampleData <- maf %>% select(Hugo_Symbol,Variant_Classification,Variant_Type,Mutation_Status,IMPACT,Tumor_Sample_UUID) %>% inner_join(patient_tumor) %>% select(-Tumor_Sample_UUID)
# sampleData %>% clipr::write_clip()
# sampleData %>% filter(patient_id == "c14b2231-3c46-4c28-8e27-11db5e5e66d0") %>% filter(Hugo_Symbol %in% saadHRD)
```

# extraction code

## KN_Chi 11781748 Figure 2
```{r}
library(imager)
im <- load.image("./11781748_figure_2.png")
w <- width(im) #1643
h <- height(im) #785
numpatients <- 115
genes = c('TP53','RB1','MDM2','CDKN2A','CDKN1B','MYC','CCND1','PTEN','PIK3R1','PIK3CA','PIK3CB','AKT1','APC','CTNNB1','RNF43','BRCA2','BRCA1','ATM','CDK12','MSH2','MSH6','MLH1','FANCA','FOXA1','FOXP1','ZBTB16','KMT2C','KMT2D','CHD1','KDM6A','SPOP','NKX3-1','ZFHX3')
h_px_per_gene <- h/33 #23.78
w_px_per_patient <- (w-7)/115 #14.287

x1 <- 7
xn <- 1634
xstep <- w/numpatients

y1 <- 10
yh1 <- 5
yn <- 775
yhn <- 780
ystep <- h/genes



# second patient first gene
gray  <- c(0.9019608,0.9058824,0.9019608)  # 0
green <- c(0.4666667,0.7058824,0.2588235)  # 1
blue  <- c(0.6117647,0.7686275,0.9098039)  # 2 
pink  <- c(0.9607843,0.5803922,0.5882353)  # 3
dblue <- c(0.2392157,0.3764706,0.6745098)  # 4
red   <- c(0.9333333,0.1647059,0.1372549)  # 5
black <- c(0.1372549,0.1215686,0.1254902)  # 6
ylw   <- c(0.9960784,0.7843137,0.0431372)  # 7 
purp  <- c(0.7333333,0.2627451,0.6000000)  # 8

colors <- list(gray,green,blue,pink,dblue,red,black,ylw,purp)

euclid <- function(x,y){ (x[1]-y[1])^2+(x[2]-y[2])^2+(x[3]-y[3])^2 }
distm <- function(x){
  distances <- sapply(colors,function(color){euclid(x,color)})
  as.character(which(distances == min(distances)) - 1)
}


patients <- c(30,92,85,94,177,59,48,46,136,55,52,146,180,71,77,168,193,151,26,18,20,58,35,99,111,72,109,98,124,44,37,156,129,172,67,43,198,15,68,160,132,110,33,51,117,149,28,102,162,154,134,93,76,88,80,121,137,27,87,39,62,126,118,190,197,75,78,191,164,159,42,114,166,86,128,153,163,189,4,74,83,112,158,183,195,31,142,176,3,12,45,56,73,194,187,6,167,8,49,54,81,108,122,53,69,89,96,104,120,131,174,192,22,140,161)
first_row <- lapply(0:(patients-1),function(x){distm(color.at(im,x1+xstep*x,y0))})

m1 <- do.call(rbind,lapply(1:length(genes),function(y){sapply(1:numpatients,function(x){distm(color.at(im,xstep*x-xstep/2,ystep*y-ystep/2))})}))
m2 <- do.call(rbind,lapply(1:length(genes),function(y){sapply(1:numpatients,function(x){distm(color.at(im,xstep*x-5,ystep*y-18))})}))
m3 <- do.call(rbind,lapply(1:length(genes),function(y){sapply(1:numpatients,function(x){distm(color.at(im,xstep*x-1,ystep*y-2))})}))

assertthat::assert_that(m1[1,1]=="1")
assertthat::assert_that(m2[1,1]=="2")
assertthat::assert_that(m3[1,1]=="2")

assertthat::assert_that(m1[10,27]=="1")
assertthat::assert_that(m2[10,27]=="5")
assertthat::assert_that(m3[10,27]=="5")

assertthat::assert_that(m1[33,28]=="7")
assertthat::assert_that(m2[33,28]=="7")
assertthat::assert_that(m3[33,28]=="0")


for(pat in 1:10){
  px <- imsub(im,x %inr% c(26*xstep,28*xstep),y %inr% c(9*ystep,10*ystep-18)) 
  plot(px)
}

                    

chars <- matrix(paste(m1,m2,m3),nrow=nrow(m1),ncol=ncol(m1))
mat <- t(chars)
colnames(mat) <- genes
rownames(mat) <- patients

color.at(im,x0+xstep,y0)
color.at(im,x=7.5,y=3)

```


# Scratch

```{r}
df <- clipr::read_clip_tbl()
pooled.dif <- function(pool.se,SE1,N1,N2){
  se2 = pool.se - SE1
}

base.patients = 245 
base.sd = 0.073
  
df2 <- df %>% 
  mutate(other_n = cumsum(patients)) #%>% 
  mutate(prev_se = lag(se,base.sd)) %>% 
  rowwise() %>% mutate(other_se = pooled.dif(prev_se,se,patients,other_n)) %>% ungroup()

effectsize::sd_pooled(sd~1,data=df2)

df3 <- df2 %>% mutate(tot_p = lag()+patients) %>% 
  mutate(tot_p = ifelse(is.na(tot_p),patients,tot_p))
sum()
```












